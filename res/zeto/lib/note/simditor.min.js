root=this,factory=function($){var slice=[].slice;return function(){Module.extend=function(obj){var key,ref,val;if(null!=obj&&"object"==typeof obj){for(key in obj){val=obj[key];"included"!==key&&"extended"!==key&&(this[key]=val)}return null!=(ref=obj.extended)?ref.call(this):void 0}};Module.include=function(obj){var key,ref,val;if(null!=obj&&"object"==typeof obj){for(key in obj){val=obj[key];"included"!==key&&"extended"!==key&&(this.prototype[key]=val)}return null!=(ref=obj.included)?ref.call(this):void 0}};Module.connect=function(cls){if("function"==typeof cls){if(!cls.pluginName)throw new Error("Module.connect: cannot connect plugin without pluginName");cls.prototype._connected=!0;this._connectedClasses||(this._connectedClasses=[]);this._connectedClasses.push(cls);return cls.pluginName?this[cls.pluginName]=cls:void 0}};Module.prototype.opts={};function Module(opts){var base,cls,i,instance,instances,len,name;this.opts=$.extend({},this.opts,opts);(base=this.constructor)._connectedClasses||(base._connectedClasses=[]);instances=function(){var i,len,ref,results;results=[];for(i=0,len=(ref=this.constructor._connectedClasses).length;i<len;i++){cls=ref[i];name=cls.pluginName.charAt(0).toLowerCase()+cls.pluginName.slice(1);cls.prototype._connected&&(cls.prototype._module=this);results.push(this[name]=new cls)}return results}.call(this);if(this._connected)this.opts=$.extend({},this.opts,this._module.opts);else{this._init();for(i=0,len=instances.length;i<len;i++)"function"==typeof(instance=instances[i])._init&&instance._init()}this.trigger("initialized")}Module.prototype._init=function(){};Module.prototype.on=function(){var args,ref;args=1<=arguments.length?slice.call(arguments,0):[];(ref=$(this)).on.apply(ref,args);return this};Module.prototype.one=function(){var args,ref;args=1<=arguments.length?slice.call(arguments,0):[];(ref=$(this)).one.apply(ref,args);return this};Module.prototype.off=function(){var args,ref;args=1<=arguments.length?slice.call(arguments,0):[];(ref=$(this)).off.apply(ref,args);return this};Module.prototype.trigger=function(){var args,ref;args=1<=arguments.length?slice.call(arguments,0):[];(ref=$(this)).trigger.apply(ref,args);return this};Module.prototype.triggerHandler=function(){var args,ref;args=1<=arguments.length?slice.call(arguments,0):[];return(ref=$(this)).triggerHandler.apply(ref,args)};Module.prototype._t=function(){var args,ref;args=1<=arguments.length?slice.call(arguments,0):[];return(ref=this.constructor)._t.apply(ref,args)};Module._t=function(){var args,key,ref,result;key=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];result=(null!=(ref=this.i18n[this.locale])?ref[key]:void 0)||"";return 0<args.length?(result=result.replace(/([^%]|^)%(?:(\d+)\$)?s/g,function(p0,p,position){return position?p+args[parseInt(position)-1]:p+args.shift()})).replace(/%%s/g,"%s"):result};Module.i18n={"zh-CN":{}};Module.locale="zh-CN";return Module}()},"function"==typeof define&&define.amd?define("simple-module",["jquery"],function(a0){return root.Module=factory(a0)}):"object"==typeof exports?module.exports=factory(require("jquery")):root.SimpleModule=factory(jQuery);var root,factory;!function(root,factory){if("function"==typeof define&&define.amd)define("simple-hotkeys",["jquery","simple-module"],function($,SimpleModule){return root.hotkeys=factory($,SimpleModule)});else if("object"==typeof exports)module.exports=factory(require("jquery"),require("simple-module"));else{root.simple=root.simple||{};root.simple.hotkeys=factory(jQuery,SimpleModule)}}(this,function($,SimpleModule){var Hotkeys,hasProp={}.hasOwnProperty;Hotkeys=function(superClass){!function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype}(Hotkeys,SimpleModule);function Hotkeys(){return Hotkeys.__super__.constructor.apply(this,arguments)}Hotkeys.count=0;Hotkeys.keyNameMap={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",91:"Meta",93:"Meta",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"Multiply",107:"Add",109:"Subtract",110:"Decimal",111:"Divide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",59:";",61:"=",186:";",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};Hotkeys.aliases={escape:"esc",delete:"del",return:"enter",ctrl:"control",space:"spacebar",ins:"insert",cmd:"meta",command:"meta",wins:"meta",windows:"meta"};Hotkeys.normalize=function(shortcut){var i,j,key,keyname,keys,len;for(i=j=0,len=(keys=shortcut.toLowerCase().replace(/\s+/gi,"").split("+")).length;j<len;i=++j){key=keys[i];keys[i]=this.aliases[key]||key}keyname=keys.pop();keys.sort().push(keyname);return keys.join("_")};Hotkeys.prototype.opts={el:document};Hotkeys.prototype._init=function(){this.id=++this.constructor.count;this._map={};this._delegate="string"==typeof this.opts.el?document:this.opts.el;return $(this._delegate).on("keydown.simple-hotkeys-"+this.id,this.opts.el,(_this=this,function(e){var ref;return null!=(ref=_this._getHander(e))?ref.call(_this,e):void 0}));var _this};Hotkeys.prototype._getHander=function(e){var keyname,shortcut;if(keyname=this.constructor.keyNameMap[e.which]){shortcut="";e.altKey&&(shortcut+="alt_");e.ctrlKey&&(shortcut+="control_");e.metaKey&&(shortcut+="meta_");e.shiftKey&&(shortcut+="shift_");shortcut+=keyname.toLowerCase();return this._map[shortcut]}};Hotkeys.prototype.respondTo=function(subject){return"string"==typeof subject?null!=this._map[this.constructor.normalize(subject)]:null!=this._getHander(subject)};Hotkeys.prototype.add=function(shortcut,handler){this._map[this.constructor.normalize(shortcut)]=handler;return this};Hotkeys.prototype.remove=function(shortcut){delete this._map[this.constructor.normalize(shortcut)];return this};Hotkeys.prototype.destroy=function(){$(this._delegate).off(".simple-hotkeys-"+this.id);this._map={};return this};return Hotkeys}();return function(opts){return new Hotkeys(opts)}});!function(root,factory){if("function"==typeof define&&define.amd)define("simple-uploader",["jquery","simple-module"],function($,SimpleModule){return root.uploader=factory($,SimpleModule)});else if("object"==typeof exports)module.exports=factory(require("jquery"),require("simple-module"));else{root.simple=root.simple||{};root.simple.uploader=factory(jQuery,SimpleModule)}}(this,function($,SimpleModule){var Uploader,hasProp={}.hasOwnProperty;Uploader=function(superClass){!function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype}(Uploader,SimpleModule);function Uploader(){return Uploader.__super__.constructor.apply(this,arguments)}Uploader.count=0;Uploader.prototype.opts={url:"",params:null,fileKey:"upload_file",connectionCount:3};Uploader.prototype._init=function(){this.files=[];this.queue=[];this.id=++Uploader.count;this.on("uploadcomplete",(_this=this,function(e,file){_this.files.splice($.inArray(file,_this.files),1);return 0<_this.queue.length&&_this.files.length<_this.opts.connectionCount?_this.upload(_this.queue.shift()):_this.uploading=!1}));var _this;return $(window).on("beforeunload.uploader-"+this.id,function(_this){return function(e){if(_this.uploading){e.originalEvent.returnValue=_this._t("leaveConfirm");return _this._t("leaveConfirm")}}}(this))};Uploader.prototype.generateId=function(){var id;id=0;return function(){return id+=1}}();Uploader.prototype.upload=function(file,opts){var f,i,key,len;null==opts&&(opts={});if(null!=file){if($.isArray(file)||file instanceof FileList)for(i=0,len=file.length;i<len;i++){f=file[i];this.upload(f,opts)}else if($(file).is("input:file")){(key=$(file).attr("name"))&&(opts.fileKey=key);this.upload($.makeArray($(file)[0].files),opts)}else file.id&&file.obj||(file=this.getFile(file));if(file&&file.obj){$.extend(file,opts);if(this.files.length>=this.opts.connectionCount)this.queue.push(file);else if(!1!==this.triggerHandler("beforeupload",[file])){this.files.push(file);zen.compress(file.obj[0],function(data,width,height){file.width=width;file.height=height;file.ext="jpg";file.obj=data;this._xhrUpload(file)},this);return this.uploading=!0}}}};Uploader.prototype.getFile=function(fileObj){var name,ref,ref1;if(!(fileObj instanceof window.File||fileObj instanceof window.Blob))return null;name=null!=(ref=fileObj.fileName)?ref:fileObj.name;return{id:this.generateId(),url:this.opts.url,params:this.opts.params,fileKey:this.opts.fileKey,name:name,size:null!=(ref1=fileObj.fileSize)?ref1:fileObj.size,ext:name?name.split(".").pop().toLowerCase():"",obj:fileObj}};Uploader.prototype._xhrUpload=function(file){var formData,k,ref,v,_this;(formData=new FormData).append(file.fileKey,file.obj);formData.append("original_filename",file.name);if(file.params){ref=file.params;for(k in ref){v=ref[k];formData.append(k,v)}}return file.xhr=$.ajax({url:file.url,data:formData,processData:!1,contentType:!1,crossDomain:!0,type:"POST",headers:{"X-File-Name":encodeURIComponent(file.name)},xhrFields:{withCredentials:!0},xhr:function(){var req,_this;(req=$.ajaxSettings.xhr())&&(req.upload.onprogress=(_this=this,function(e){return _this.progress(e)}));return req},progress:(_this=this,function(e){if(e.lengthComputable){file.img.attr("width",file.width);file.img.attr("height",file.height);return _this.trigger("uploadprogress",[file,e.loaded,e.total])}}),error:function(_this){return function(xhr,status,err){return _this.trigger("uploaderror",[file,xhr,status])}}(this),success:function(_this){return function(result){_this.trigger("uploadprogress",[file,file.size,file.size]);_this.trigger("uploadsuccess",[file,result]);return $(document).trigger("uploadsuccess",[file,result,_this])}}(this),complete:function(_this){return function(xhr,status){return _this.trigger("uploadcomplete",[file,xhr.responseText])}}(this)})};Uploader.prototype.cancel=function(file){var f,i,len,ref;if(!file.id)for(i=0,len=(ref=this.files).length;i<len;i++)if((f=ref[i]).id===1*file){file=f;break}this.trigger("uploadcancel",[file]);file.xhr&&file.xhr.abort();return file.xhr=null};Uploader.prototype.readImageFile=function(fileObj,callback){var fileReader,img;if($.isFunction(callback)){(img=new Image).onload=function(){return callback(img)};img.onerror=function(){return callback()};if(window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(fileObj.type)){(fileReader=new FileReader).onload=function(e){return img.src=e.target.result};return fileReader.readAsDataURL(fileObj)}return callback()}};Uploader.prototype.destroy=function(){var file,i,len,ref;for(i=this.queue.length=0,len=(ref=this.files).length;i<len;i++){file=ref[i];this.cancel(file)}$(window).off(".uploader-"+this.id);return $(document).off(".uploader-"+this.id)};Uploader.i18n={"zh-CN":{leaveConfirm:"正在上传文件，如果离开上传会自动取消"}};Uploader.locale="zh-CN";return Uploader}();return function(opts){return new Uploader(opts)}});!function(root,factory){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader","dompurify"],function($,SimpleModule,simpleHotkeys,simpleUploader,DOMPurify){return root.Simditor=factory($,SimpleModule,simpleHotkeys,simpleUploader,DOMPurify)}):"object"==typeof exports?module.exports=factory(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader"),require("dompurify")):root.Simditor=factory(jQuery,SimpleModule,simple.hotkeys,simple.uploader,window.DOMPurify)}(this,function($,SimpleModule,simpleHotkeys,simpleUploader,DOMPurify){var AlignmentButton,BlockquoteButton,BoldButton,Button,Clipboard,CodeButton,CodePopover,ColorButton,FontScaleButton,Formatter,HrButton,ImageButton,ImagePopover,IndentButton,Indentation,InputManager,ItalicButton,Keystroke,LinkButton,LinkPopover,ListButton,OrderListButton,OutdentButton,Popover,Selection,Simditor,StrikethroughButton,TableButton,TitleButton,Toolbar,UnderlineButton,UndoManager,UnorderListButton,Util,extend=function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1},slice=[].slice;Selection=function(superClass){extend(Selection,SimpleModule);function Selection(){return Selection.__super__.constructor.apply(this,arguments)}Selection.pluginName="Selection";Selection.prototype._range=null;Selection.prototype._startNodes=null;Selection.prototype._endNodes=null;Selection.prototype._containerNode=null;Selection.prototype._nodes=null;Selection.prototype._blockNodes=null;Selection.prototype._rootNodes=null;Selection.prototype._init=function(){this.editor=this._module;this._selection=document.getSelection();this.editor.on("selectionchanged",(_this=this,function(e){_this.reset();return _this._range=_this._selection.getRangeAt(0)}));var _this;this.editor.on("blur",function(_this){return function(e){return _this.reset()}}(this));return this.editor.on("focus",function(_this){return function(e){_this.reset();return _this._range=_this._selection.getRangeAt(0)}}(this))};Selection.prototype.reset=function(){this._range=null;this._startNodes=null;this._endNodes=null;this._containerNode=null;this._nodes=null;this._blockNodes=null;return this._rootNodes=null};Selection.prototype.clear=function(){try{this._selection.removeAllRanges()}catch(_error){_error}return this.reset()};Selection.prototype.range=function(range){var ffOrIE;if(range){this.clear();this._selection.addRange(range);this._range=range;ffOrIE=this.editor.util.browser.firefox||this.editor.util.browser.msie;!this.editor.inputManager.focused&&ffOrIE&&this.editor.body.focus()}else!this._range&&this.editor.inputManager.focused&&this._selection.rangeCount&&(this._range=this._selection.getRangeAt(0));return this._range};Selection.prototype.startNodes=function(){this._range&&(this._startNodes||(this._startNodes=(_this=this,function(){var startNodes;(startNodes=$(_this._range.startContainer).parentsUntil(_this.editor.body).get()).unshift(_this._range.startContainer);return $(startNodes)})()));var _this;return this._startNodes};Selection.prototype.endNodes=function(){var endNodes;this._range&&(this._endNodes||(this._endNodes=this._range.collapsed?this.startNodes():((endNodes=$(this._range.endContainer).parentsUntil(this.editor.body).get()).unshift(this._range.endContainer),$(endNodes))));return this._endNodes};Selection.prototype.containerNode=function(){this._range&&(this._containerNode||(this._containerNode=$(this._range.commonAncestorContainer)));return this._containerNode};Selection.prototype.nodes=function(){this._range&&(this._nodes||(this._nodes=(_this=this,function(){var nodes;nodes=[];if(_this.startNodes().first().is(_this.endNodes().first()))nodes=_this.startNodes().get();else{_this.startNodes().each(function(i,node){var $endNode,$node,$nodes,endIndex,index,sharedIndex,startIndex;$node=$(node);if(-1<_this.endNodes().index($node))return nodes.push(node);if($node.parent().is(_this.editor.body)||-1<(sharedIndex=_this.endNodes().index($node.parent()))){$endNode=sharedIndex&&-1<sharedIndex?_this.endNodes().eq(sharedIndex-1):_this.endNodes().last();startIndex=($nodes=$node.parent().contents()).index($node);endIndex=$nodes.index($endNode);return $.merge(nodes,$nodes.slice(startIndex,endIndex).get())}index=($nodes=$node.parent().contents()).index($node);return $.merge(nodes,$nodes.slice(index).get())});_this.endNodes().each(function(i,node){var $node,$nodes,index;if(($node=$(node)).parent().is(_this.editor.body)||-1<_this.startNodes().index($node.parent())){nodes.push(node);return!1}index=($nodes=$node.parent().contents()).index($node);return $.merge(nodes,$nodes.slice(0,index+1))})}return $($.unique(nodes))})()));var _this;return this._nodes};Selection.prototype.blockNodes=function(){if(this._range){this._blockNodes||(this._blockNodes=(_this=this,function(){return _this.nodes().filter(function(i,node){return _this.editor.util.isBlockNode(node)})})());var _this;return this._blockNodes}};Selection.prototype.rootNodes=function(){if(this._range){this._rootNodes||(this._rootNodes=(_this=this,function(){return _this.nodes().filter(function(i,node){var $parent;return($parent=$(node).parent()).is(_this.editor.body)||$parent.is("blockquote")})})());var _this;return this._rootNodes}};Selection.prototype.rangeAtEndOf=function(node,range){var afterLastNode,beforeLastNode,endNode,endNodeLength,lastNodeIsBr,result;null==range&&(range=this.range());if(range&&range.collapsed){node=$(node)[0];endNode=range.endContainer;endNodeLength=this.editor.util.getNodeLength(endNode);beforeLastNode=range.endOffset===endNodeLength-1;lastNodeIsBr=$(endNode).contents().last().is("br");afterLastNode=range.endOffset===endNodeLength;if(!(beforeLastNode&&lastNodeIsBr||afterLastNode))return!1;if(node===endNode)return!0;if(!$.contains(node,endNode))return!1;result=!0;$(endNode).parentsUntil(node).addBack().each(function(i,n){var $lastChild,beforeLastbr,isLastNode;isLastNode=($lastChild=$(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}).last()).get(0)===n;beforeLastbr=$lastChild.is("br")&&$lastChild.prev().get(0)===n;if(!isLastNode&&!beforeLastbr)return result=!1});return result}};Selection.prototype.rangeAtStartOf=function(node,range){var result,startNode;null==range&&(range=this.range());if(range&&range.collapsed){node=$(node)[0];startNode=range.startContainer;if(0!==range.startOffset)return!1;if(node===startNode)return!0;if(!$.contains(node,startNode))return!1;result=!0;$(startNode).parentsUntil(node).addBack().each(function(i,n){if($(n).parent().contents().filter(function(){return!(this!==n&&3===this.nodeType&&!this.nodeValue)}).first().get(0)!==n)return result=!1});return result}};Selection.prototype.insertNode=function(node,range){null==range&&(range=this.range());if(range){node=$(node)[0];range.insertNode(node);return this.setRangeAfter(node,range)}};Selection.prototype.setRangeAfter=function(node,range){null==range&&(range=this.range());if(null!=range){node=$(node)[0];range.setEndAfter(node);range.collapse(!1);return this.range(range)}};Selection.prototype.setRangeBefore=function(node,range){null==range&&(range=this.range());if(null!=range){node=$(node)[0];range.setEndBefore(node);range.collapse(!1);return this.range(range)}};Selection.prototype.setRangeAtStartOf=function(node,range){null==range&&(range=this.range());node=$(node).get(0);range.setEnd(node,0);range.collapse(!1);return this.range(range)};Selection.prototype.setRangeAtEndOf=function(node,range){var $lastNode,$node,contents,lastChild,lastChildLength,lastText,nodeLength;null==range&&(range=this.range());if(node=($node=$(node))[0]){if($node.is("pre"))if(0<(contents=$node.contents()).length){lastText=(lastChild=contents.last()).text();lastChildLength=this.editor.util.getNodeLength(lastChild[0]);"\n"===lastText.charAt(lastText.length-1)?range.setEnd(lastChild[0],lastChildLength-1):range.setEnd(lastChild[0],lastChildLength)}else range.setEnd(node,0);else{nodeLength=this.editor.util.getNodeLength(node);if(3!==node.nodeType&&0<nodeLength)if(($lastNode=$(node).contents().last()).is("br"))nodeLength-=1;else if(3!==$lastNode[0].nodeType&&this.editor.util.isEmptyNode($lastNode)){$lastNode.append(this.editor.util.phBr);node=$lastNode[0];nodeLength=0}range.setEnd(node,nodeLength)}range.collapse(!1);return this.range(range)}};Selection.prototype.deleteRangeContents=function(range){var atEndOfBody,atStartOfBody,endRange,startRange;null==range&&(range=this.range());startRange=range.cloneRange();endRange=range.cloneRange();startRange.collapse(!0);endRange.collapse(!1);atStartOfBody=this.rangeAtStartOf(this.editor.body,startRange);atEndOfBody=this.rangeAtEndOf(this.editor.body,endRange);if(!range.collapsed&&atStartOfBody&&atEndOfBody){this.editor.body.empty();range.setStart(this.editor.body[0],0);range.collapse(!0);this.range(range)}else range.deleteContents();return range};Selection.prototype.breakBlockEl=function(el,range){var $el;null==range&&(range=this.range());$el=$(el);if(!range.collapsed)return $el;range.setStartBefore($el.get(0));return range.collapsed?$el:$el.before(range.extractContents())};Selection.prototype.save=function(range){var endCaret,endRange,startCaret;null==range&&(range=this.range());if(!this._selectionSaved){(endRange=range.cloneRange()).collapse(!1);startCaret=$("<span/>").addClass("simditor-caret-start");endCaret=$("<span/>").addClass("simditor-caret-end");endRange.insertNode(endCaret[0]);range.insertNode(startCaret[0]);this.clear();return this._selectionSaved=!0}};Selection.prototype.restore=function(){var endCaret,endContainer,endOffset,range,startCaret,startContainer,startOffset;if(!this._selectionSaved)return!1;startCaret=this.editor.body.find(".simditor-caret-start");endCaret=this.editor.body.find(".simditor-caret-end");if(startCaret.length&&endCaret.length){startOffset=(startContainer=startCaret.parent()).contents().index(startCaret);endOffset=(endContainer=endCaret.parent()).contents().index(endCaret);startContainer[0]===endContainer[0]&&(endOffset-=1);(range=document.createRange()).setStart(startContainer.get(0),startOffset);range.setEnd(endContainer.get(0),endOffset);startCaret.remove();endCaret.remove();this.range(range)}else{startCaret.remove();endCaret.remove()}this._selectionSaved=!1;return range};return Selection}();Formatter=function(superClass){extend(Formatter,SimpleModule);function Formatter(){return Formatter.__super__.constructor.apply(this,arguments)}Formatter.pluginName="Formatter";Formatter.prototype.opts={allowedTags:[],allowedAttributes:{},allowedStyles:{}};Formatter.prototype._init=function(){this.editor=this._module;this._allowedTags=$.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags);this._allowedAttributes=$.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes);this._allowedStyles=$.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles);return this.editor.body.on("click","a",function(e){return!1})};Formatter.prototype.decorate=function($el){null==$el&&($el=this.editor.body);this.editor.trigger("decorate",[$el]);return $el};Formatter.prototype.undecorate=function($el){null==$el&&($el=this.editor.body.clone());this.editor.trigger("undecorate",[$el]);return $el};Formatter.prototype.autolink=function($el){var $link,$node,findLinkNode,k,lastIndex,len,linkNodes,match,re,replaceEls,subStr,text,uri;null==$el&&($el=this.editor.body);linkNodes=[];(findLinkNode=function($parentNode){return $parentNode.contents().each(function(i,node){var $node,text;if(!($node=$(node)).is("a")&&!$node.closest("a, pre",$el).length)return!$node.is("iframe")&&$node.contents().length?findLinkNode($node):(text=$node.text())&&/https?:\/\/|www\./gi.test(text)?linkNodes.push($node):void 0})})($el);re=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi;for(k=0,len=linkNodes.length;k<len;k++){text=($node=linkNodes[k]).text();replaceEls=[];match=null;lastIndex=0;for(;null!==(match=re.exec(text));){subStr=text.substring(lastIndex,match.index);replaceEls.push(document.createTextNode(subStr));lastIndex=re.lastIndex;uri=/^(http(s)?:\/\/|\/)/.test(match[0])?match[0]:"http://"+match[0];$link=$('<a href="'+uri+'" rel="nofollow"></a>').text(match[0]);replaceEls.push($link[0])}replaceEls.push(document.createTextNode(text.substring(lastIndex)));$node.replaceWith($(replaceEls))}return $el};Formatter.prototype.format=function($el){var $node,blockNode,k,l,len,len1,n,node,ref,ref1;null==$el&&($el=this.editor.body);if($el.is(":empty")){$el.append("<p>"+this.editor.util.phBr+"</p>");return $el}for(k=0,len=(ref=$el.contents()).length;k<len;k++){n=ref[k];this.cleanNode(n,!0)}for(l=0,len1=(ref1=$el.contents()).length;l<len1;l++){node=ref1[l];if(($node=$(node)).is("br")){null!=blockNode&&(blockNode=null);$node.remove()}else if(this.editor.util.isBlockNode(node))$node.is("li")?blockNode&&blockNode.is("ul, ol")?blockNode.append(node):(blockNode=$("<ul/>").insertBefore(node)).append(node):blockNode=null;else{blockNode&&!blockNode.is("ul, ol")||(blockNode=$("<p/>").insertBefore(node));blockNode.append(node);this.editor.util.isEmptyNode(blockNode)&&blockNode.append(this.editor.util.phBr)}}return $el};Formatter.prototype.cleanNode=function(node,recursive){var $blockEls,$childImg,$node,$p,$td,allowedAttributes,attr,contents,isDecoration,k,l,len,len1,n,ref,ref1,text,textNode;if(0<($node=$(node)).length){if(3!==$node[0].nodeType){contents=$node.is("iframe")?null:$node.contents();isDecoration=this.editor.util.isDecoratedNode($node);if($node.is(this._allowedTags.join(","))||isDecoration){if($node.is("a")&&0<($childImg=$node.find("img")).length){$node.replaceWith($childImg);$node=$childImg;contents=null}if($node.is("td")&&0<($blockEls=$node.find(this.editor.util.blockNodes.join(","))).length){$blockEls.each(function(i,blockEl){return $(blockEl).contents().unwrap()});contents=$node.contents()}$node.is("img")&&$node.hasClass("uploading")&&$node.remove();if(!isDecoration){allowedAttributes=this._allowedAttributes[$node[0].tagName.toLowerCase()];for(k=0,len=(ref=$.makeArray($node[0].attributes)).length;k<len;k++)"style"!==(attr=ref[k]).name&&(null!=allowedAttributes&&(ref1=attr.name,0<=indexOf.call(allowedAttributes,ref1))||$node.removeAttr(attr.name));this._cleanNodeStyles($node);if($node.is("span")){0===$node[0].attributes.length&&$node.contents().first().unwrap();2===$node[0].style.length&&"rgb(51, 51, 51)"===$node[0].style.color&&"16px"===$node[0].style.fontSize&&$node.contents().unwrap()}}}else if(1!==$node[0].nodeType||$node.is(":empty")){$node.remove();contents=null}else if($node.is("div, article, dl, header, footer, tr")){$node.append("<br/>");contents.first().unwrap()}else if($node.is("table")){$p=$("<p/>");$node.find("tr").each(function(i,tr){return $p.append($(tr).text()+"<br/>")});$node.replaceWith($p);contents=null}else if($node.is("thead, tfoot")){$node.remove();contents=null}else if($node.is("th")){$td=$("<td/>").append($node.contents());$node.replaceWith($td)}else contents.first().unwrap();if(recursive&&null!=contents&&!$node.is("pre"))for(l=0,len1=contents.length;l<len1;l++){n=contents[l];this.cleanNode(n,!0)}return null}if(text=$node.text().replace(/(\r\n|\n|\r)/gm,"")){textNode=document.createTextNode(text);$node.replaceWith(textNode)}else $node.remove()}};Formatter.prototype._cleanNodeStyles=function($node){var allowedStyles,k,len,pair,ref,ref1,style,styleStr,styles;if(styleStr=$node.attr("style")){$node.removeAttr("style");if(!((allowedStyles=this._allowedStyles[$node[0].tagName.toLowerCase()])&&0<allowedStyles.length))return $node;styles={};for(k=0,len=(ref=styleStr.split(";")).length;k<len;k++){style=ref[k];2===(pair=(style=$.trim(style)).split(":")).length&&("font-size"===pair[0]&&0<pair[1].indexOf("px")&&parseInt(pair[1],10)<12||(ref1=pair[0],0<=indexOf.call(allowedStyles,ref1))&&(styles[$.trim(pair[0])]=$.trim(pair[1])))}0<Object.keys(styles).length&&$node.css(styles);return $node}};Formatter.prototype.clearHtml=function(html,lineBreak){var container,contents,result,_this;null==lineBreak&&(lineBreak=!0);container=$("<div/>").append(html);contents=container.contents();result="";contents.each((_this=this,function(i,node){var $node,children;if(3===node.nodeType)return result+=node.nodeValue;if(1===node.nodeType){(children=($node=$(node)).is("iframe")?null:$node.contents())&&0<children.length&&(result+=_this.clearHtml(children));if(lineBreak&&i<contents.length-1&&$node.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))return result+="\n"}}));return result};Formatter.prototype.beautify=function($contents){var uselessP;uselessP=function($el){return!!($el.is("p")&&!$el.text()&&$el.children(":not(br)").length<1)};return $contents.each(function(i,el){var $el;(($el=$(el)).is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')||uselessP($el))&&$el.remove();return $el.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})};return Formatter}();InputManager=function(superClass){extend(InputManager,SimpleModule);function InputManager(){return InputManager.__super__.constructor.apply(this,arguments)}InputManager.pluginName="InputManager";InputManager.prototype._modifierKeys=[16,17,18,91,93,224];InputManager.prototype._arrowKeys=[37,38,39,40];InputManager.prototype._init=function(){var selectAllKey,submitKey,_this;this.editor=this._module;this.throttledValueChanged=this.editor.util.throttle((_this=this,function(params){return setTimeout(function(){return _this.editor.trigger("valuechanged",params)},10)}),300);this.throttledSelectionChanged=this.editor.util.throttle(function(_this){return function(){return _this.editor.trigger("selectionchanged")}}(this),50);$(document).on("selectionchange.simditor"+this.editor.id,function(_this){return function(e){var triggerEvent;if(_this.focused&&!_this.editor.clipboard.pasting)return(triggerEvent=function(){if(_this._selectionTimer){clearTimeout(_this._selectionTimer);_this._selectionTimer=null}return 0<_this.editor.selection._selection.rangeCount?_this.throttledSelectionChanged():_this._selectionTimer=setTimeout(function(){_this._selectionTimer=null;if(_this.focused)return triggerEvent()},10)})()}}(this));this.editor.on("valuechanged",function(_this){return function(){var $rootBlocks;_this.lastCaretPosition=null;$rootBlocks=_this.editor.body.children().filter(function(i,node){return _this.editor.util.isBlockNode(node)});if(_this.focused&&0===$rootBlocks.length){_this.editor.selection.save();_this.editor.formatter.format();_this.editor.selection.restore()}_this.editor.body.find("hr, pre, .simditor-table").each(function(i,el){var $el,formatted;if(($el=$(el)).parent().is("blockquote")||$el.parent()[0]===_this.editor.body[0]){formatted=!1;if(0===$el.next().length){$("<p/>").append(_this.editor.util.phBr).insertAfter($el);formatted=!0}if(0===$el.prev().length){$("<p/>").append(_this.editor.util.phBr).insertBefore($el);formatted=!0}if(formatted)return _this.throttledValueChanged()}});_this.editor.body.find("pre:empty").append(_this.editor.util.phBr);if(!_this.editor.util.support.onselectionchange&&_this.focused)return _this.throttledSelectionChanged()}}(this));this.editor.body.on("keydown",$.proxy(this._onKeyDown,this)).on("keypress",$.proxy(this._onKeyPress,this)).on("keyup",$.proxy(this._onKeyUp,this)).on("mouseup",$.proxy(this._onMouseUp,this)).on("focus",$.proxy(this._onFocus,this)).on("blur",$.proxy(this._onBlur,this)).on("drop",$.proxy(this._onDrop,this)).on("input",$.proxy(this._onInput,this));if(this.editor.util.browser.firefox){this.editor.hotkeys.add("cmd+left",function(_this){return function(e){e.preventDefault();_this.editor.selection._selection.modify("move","backward","lineboundary");return!1}}(this));this.editor.hotkeys.add("cmd+right",function(_this){return function(e){e.preventDefault();_this.editor.selection._selection.modify("move","forward","lineboundary");return!1}}(this));selectAllKey=this.editor.util.os.mac?"cmd+a":"ctrl+a";this.editor.hotkeys.add(selectAllKey,function(_this){return function(e){var $children,firstBlock,lastBlock,range;if(0<($children=_this.editor.body.children()).length){firstBlock=$children.first().get(0);lastBlock=$children.last().get(0);(range=document.createRange()).setStart(firstBlock,0);range.setEnd(lastBlock,_this.editor.util.getNodeLength(lastBlock));_this.editor.selection.range(range);return!1}}}(this))}submitKey=this.editor.util.os.mac?"cmd+enter":"ctrl+enter";return this.editor.hotkeys.add(submitKey,function(_this){return function(e){_this.editor.sync();_this.editor.el.closest("form").find("button:submit").click();return!1}}(this))};InputManager.prototype._onFocus=function(e){if(!this.editor.clipboard.pasting){this.editor.el.addClass("focus").removeClass("error");this.focused=!0;return setTimeout((_this=this,function(){var $blockEl,range;if((range=_this.editor.selection._selection.getRangeAt(0)).startContainer===_this.editor.body[0])if(_this.lastCaretPosition)_this.editor.undoManager.caretPosition(_this.lastCaretPosition);else{$blockEl=_this.editor.body.children().first();range=document.createRange();_this.editor.selection.setRangeAtStartOf($blockEl,range)}_this.lastCaretPosition=null;_this.editor.triggerHandler("focus");if(!_this.editor.util.support.onselectionchange)return _this.throttledSelectionChanged()}),0);var _this}};InputManager.prototype._onBlur=function(e){var ref;if(!this.editor.clipboard.pasting){this.editor.el.removeClass("focus");this.editor.sync();this.focused=!1;this.lastCaretPosition=null!=(ref=this.editor.undoManager.currentState())?ref.caret:void 0;return this.editor.triggerHandler("blur")}};InputManager.prototype._onMouseUp=function(e){if(!this.editor.util.support.onselectionchange)return this.throttledSelectionChanged()};InputManager.prototype._onKeyDown=function(e){var ref,ref1;if(!1===this.editor.triggerHandler(e))return!1;if(!this.editor.hotkeys.respondTo(e)){if(this.editor.keystroke.respondTo(e)){this.throttledValueChanged();return!1}if(!((ref=e.which,0<=indexOf.call(this._modifierKeys,ref))||(ref1=e.which,0<=indexOf.call(this._arrowKeys,ref1))||this.editor.util.metaKey(e)&&86===e.which)){this.editor.util.support.oninput||this.throttledValueChanged(["typing"]);return null}}};InputManager.prototype._onKeyPress=function(e){if(!1===this.editor.triggerHandler(e))return!1};InputManager.prototype._onKeyUp=function(e){var p,ref;if(!1===this.editor.triggerHandler(e))return!1;if(!this.editor.util.support.onselectionchange&&(ref=e.which,0<=indexOf.call(this._arrowKeys,ref)))this.throttledValueChanged();else if((8===e.which||46===e.which)&&this.editor.util.isEmptyNode(this.editor.body)){this.editor.body.empty();p=$("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body);this.editor.selection.setRangeAtStartOf(p)}};InputManager.prototype._onDrop=function(e){return!1!==this.editor.triggerHandler(e)&&this.throttledValueChanged()};InputManager.prototype._onInput=function(e){return this.throttledValueChanged(["oninput"])};return InputManager}();Keystroke=function(superClass){extend(Keystroke,SimpleModule);function Keystroke(){return Keystroke.__super__.constructor.apply(this,arguments)}Keystroke.pluginName="Keystroke";Keystroke.prototype._init=function(){this.editor=this._module;this._keystrokeHandlers={};return this._initKeystrokeHandlers()};Keystroke.prototype.add=function(key,node,handler){key=key.toLowerCase();key=this.editor.hotkeys.constructor.aliases[key]||key;this._keystrokeHandlers[key]||(this._keystrokeHandlers[key]={});return this._keystrokeHandlers[key][node]=handler};Keystroke.prototype.respondTo=function(e){var base,key,ref,result;if(key=null!=(ref=this.editor.hotkeys.constructor.keyNameMap[e.which])?ref.toLowerCase():void 0){if(key in this._keystrokeHandlers){(result="function"==typeof(base=this._keystrokeHandlers[key])["*"]?base["*"](e):void 0)||this.editor.selection.startNodes().each((_this=this,function(i,node){var handler,ref1;if(node.nodeType===Node.ELEMENT_NODE){handler=null!=(ref1=_this._keystrokeHandlers[key])?ref1[node.tagName.toLowerCase()]:void 0;return!0!==(result="function"==typeof handler?handler(e,$(node)):void 0)&&!1!==result&&void 0}}));if(result)return!0}var _this}};Keystroke.prototype._initKeystrokeHandlers=function(){var titleEnterHandler,_this;this.editor.util.browser.safari&&this.add("enter","*",(_this=this,function(e){var $blockEl,$br;if(e.shiftKey&&!($blockEl=_this.editor.selection.blockNodes().last()).is("pre")){$br=$("<br/>");if(_this.editor.selection.rangeAtEndOf($blockEl)){_this.editor.selection.insertNode($br);_this.editor.selection.insertNode($("<br/>"));_this.editor.selection.setRangeBefore($br)}else _this.editor.selection.insertNode($br);return!0}}));if(this.editor.util.browser.webkit||this.editor.util.browser.msie){titleEnterHandler=function(_this){return function(e,$node){var $p;if(_this.editor.selection.rangeAtEndOf($node)){$p=$("<p/>").append(_this.editor.util.phBr).insertAfter($node);_this.editor.selection.setRangeAtStartOf($p);return!0}}}(this);this.add("enter","h1",titleEnterHandler);this.add("enter","h2",titleEnterHandler);this.add("enter","h3",titleEnterHandler);this.add("enter","h4",titleEnterHandler);this.add("enter","h5",titleEnterHandler);this.add("enter","h6",titleEnterHandler)}this.add("backspace","*",function(_this){return function(e){var $blockEl,$prevBlockEl,$rootBlock;if(($prevBlockEl=($rootBlock=_this.editor.selection.rootNodes().first()).prev()).is("hr")&&_this.editor.selection.rangeAtStartOf($rootBlock)){_this.editor.selection.save();$prevBlockEl.remove();_this.editor.selection.restore();return!0}if(($blockEl=_this.editor.selection.blockNodes().last()).is(".simditor-resize-handle")&&$rootBlock.is(".simditor-table")){e.preventDefault();$rootBlock.remove();_this.editor.selection.setRangeAtEndOf($prevBlockEl)}if($prevBlockEl.is(".simditor-table")&&!$blockEl.is("table")&&_this.editor.util.isEmptyNode($blockEl)){e.preventDefault();$blockEl.remove();_this.editor.selection.setRangeAtEndOf($prevBlockEl)}if(_this.editor.util.browser.webkit&&_this.editor.selection.rangeAtStartOf($blockEl)){_this.editor.selection.save();_this.editor.formatter.cleanNode($blockEl,!0);_this.editor.selection.restore();return null}}}(this));this.add("enter","div",function(_this){return function(e,$node){var $p;if($node.is(".simditor-table")&&_this.editor.selection.blockNodes().last().is(".simditor-resize-handle")){e.preventDefault();$p=$("<p/>").append(_this.editor.util.phBr).insertAfter($node);return _this.editor.selection.setRangeAtStartOf($p)}}}(this));this.add("enter","li",function(_this){return function(e,$node){var $cloneNode,listEl,newBlockEl,newListEl;($cloneNode=$node.clone()).find("ul, ol").remove();if(_this.editor.util.isEmptyNode($cloneNode)&&$node.is(_this.editor.selection.blockNodes().last())){listEl=$node.parent();if(0<$node.next("li").length){if(!_this.editor.util.isEmptyNode($node))return;if(0<listEl.parent("li").length){newBlockEl=$("<li/>").append(_this.editor.util.phBr).insertAfter(listEl.parent("li"));newListEl=$("<"+listEl[0].tagName+"/>").append($node.nextAll("li"));newBlockEl.append(newListEl)}else{newBlockEl=$("<p/>").append(_this.editor.util.phBr).insertAfter(listEl);newListEl=$("<"+listEl[0].tagName+"/>").append($node.nextAll("li"));newBlockEl.after(newListEl)}}else if(0<listEl.parent("li").length){newBlockEl=$("<li/>").insertAfter(listEl.parent("li"));0<$node.contents().length?newBlockEl.append($node.contents()):newBlockEl.append(_this.editor.util.phBr)}else{newBlockEl=$("<p/>").append(_this.editor.util.phBr).insertAfter(listEl);0<$node.children("ul, ol").length&&newBlockEl.after($node.children("ul, ol"))}$node.prev("li").length?$node.remove():$node.prev("ul").length||$node.prev("ol").length?$node.remove():listEl.remove();_this.editor.selection.setRangeAtStartOf(newBlockEl);return!0}}}(this));this.add("enter","pre",function(_this){return function(e,$node){var $p,breakNode,range;e.preventDefault();if(e.shiftKey){$p=$("<p/>").append(_this.editor.util.phBr).insertAfter($node);_this.editor.selection.setRangeAtStartOf($p);return!0}breakNode=null;(range=_this.editor.selection.range()).deleteContents();breakNode=!_this.editor.util.browser.msie&&_this.editor.selection.rangeAtEndOf($node)?document.createTextNode("\n\n"):document.createTextNode("\n");range.insertNode(breakNode);range.setEnd(breakNode,1);range.collapse(!1);_this.editor.selection.range(range);return!0}}(this));this.add("enter","blockquote",function(_this){return function(e,$node){var $closestBlock,range;if(($closestBlock=_this.editor.selection.blockNodes().last()).is("p")&&!$closestBlock.next().length&&_this.editor.util.isEmptyNode($closestBlock)){$node.after($closestBlock);range=document.createRange();_this.editor.selection.setRangeAtStartOf($closestBlock,range);return!0}}}(this));this.add("backspace","li",function(_this){return function(e,$node){var $br,$childList,$newLi,$prevChildList,$prevNode,$textNode,isFF,range,text;$childList=$node.children("ul, ol");$prevNode=$node.prev("li");if(!(0<$childList.length&&0<$prevNode.length))return!1;text="";$textNode=null;$node.contents().each(function(i,n){if(1===n.nodeType&&/UL|OL/.test(n.nodeName))return!1;if(1!==n.nodeType||!/BR/.test(n.nodeName)){3===n.nodeType&&n.nodeValue?text+=n.nodeValue:1===n.nodeType&&(text+=$(n).text());return $textNode=$(n)}});isFF=_this.editor.util.browser.firefox&&!$textNode.next("br").length;if($textNode&&1===text.length&&isFF){$br=$(_this.editor.util.phBr).insertAfter($textNode);$textNode.remove();_this.editor.selection.setRangeBefore($br);return!0}if(0<text.length)return!1;range=document.createRange();if(0<($prevChildList=$prevNode.children("ul, ol")).length){$newLi=$("<li/>").append(_this.editor.util.phBr).appendTo($prevChildList);$prevChildList.append($childList.children("li"));$node.remove();_this.editor.selection.setRangeAtEndOf($newLi,range)}else{_this.editor.selection.setRangeAtEndOf($prevNode,range);$prevNode.append($childList);$node.remove();_this.editor.selection.range(range)}return!0}}(this));this.add("backspace","pre",function(_this){return function(e,$node){var $newNode,codeStr,range;if(_this.editor.selection.rangeAtStartOf($node)){codeStr=$node.html().replace("\n","<br/>")||_this.editor.util.phBr;$newNode=$("<p/>").append(codeStr).insertAfter($node);$node.remove();range=document.createRange();_this.editor.selection.setRangeAtStartOf($newNode,range);return!0}}}(this));return this.add("backspace","blockquote",function(_this){return function(e,$node){var $firstChild,range;if(_this.editor.selection.rangeAtStartOf($node)){$firstChild=$node.children().first().unwrap();range=document.createRange();_this.editor.selection.setRangeAtStartOf($firstChild,range);return!0}}}(this))};return Keystroke}();UndoManager=function(superClass){extend(UndoManager,SimpleModule);function UndoManager(){return UndoManager.__super__.constructor.apply(this,arguments)}UndoManager.pluginName="UndoManager";UndoManager.prototype._index=-1;UndoManager.prototype._capacity=20;UndoManager.prototype._startPosition=null;UndoManager.prototype._endPosition=null;UndoManager.prototype._init=function(){var redoShortcut,undoShortcut,_this;this.editor=this._module;this._stack=[];if(this.editor.util.os.mac){undoShortcut="cmd+z";redoShortcut="shift+cmd+z"}else if(this.editor.util.os.win){undoShortcut="ctrl+z";redoShortcut="ctrl+y"}else{undoShortcut="ctrl+z";redoShortcut="shift+ctrl+z"}this.editor.hotkeys.add(undoShortcut,(_this=this,function(e){e.preventDefault();_this.undo();return!1}));this.editor.hotkeys.add(redoShortcut,function(_this){return function(e){e.preventDefault();_this.redo();return!1}}(this));this.throttledPushState=this.editor.util.throttle(function(_this){return function(){return _this._pushUndoState()}}(this),2e3);this.editor.on("valuechanged",function(_this){return function(e,src){if("undo"!==src&&"redo"!==src)return _this.throttledPushState()}}(this));this.editor.on("selectionchanged",function(_this){return function(e){_this.resetCaretPosition();return _this.update()}}(this));this.editor.on("focus",function(_this){return function(e){if(0===_this._stack.length)return _this._pushUndoState()}}(this));return this.editor.on("blur",function(_this){return function(e){return _this.resetCaretPosition()}}(this))};UndoManager.prototype.resetCaretPosition=function(){this._startPosition=null;return this._endPosition=null};UndoManager.prototype.startPosition=function(){this.editor.selection._range&&(this._startPosition||(this._startPosition=this._getPosition("start")));return this._startPosition};UndoManager.prototype.endPosition=function(){this.editor.selection._range&&(this._endPosition||(this._endPosition=(_this=this,function(){return _this.editor.selection.range().collapsed?_this._startPosition:_this._getPosition("end")})()));var _this;return this._endPosition};UndoManager.prototype._pushUndoState=function(){if(!1!==this.editor.triggerHandler("pushundostate")&&this.caretPosition().start){this._index+=1;this._stack.length=this._index;this._stack.push({html:this.editor.body.html(),caret:this.caretPosition()});if(this._stack.length>this._capacity){this._stack.shift();return this._index-=1}}};UndoManager.prototype.currentState=function(){return this._stack.length&&-1<this._index?this._stack[this._index]:null};UndoManager.prototype.undo=function(){var state;if(!(this._index<1||this._stack.length<2)){this.editor.hidePopover();this._index-=1;state=this._stack[this._index];this.editor.body.get(0).innerHTML=state.html;this.caretPosition(state.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["undo"])}};UndoManager.prototype.redo=function(){var state;if(!(this._index<0||this._stack.length<this._index+2)){this.editor.hidePopover();this._index+=1;state=this._stack[this._index];this.editor.body.get(0).innerHTML=state.html;this.caretPosition(state.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["redo"])}};UndoManager.prototype.update=function(){var currentState;if(currentState=this.currentState()){currentState.html=this.editor.body.html();return currentState.caret=this.caretPosition()}};UndoManager.prototype._getNodeOffset=function(node,index){var $parent,merging,offset;$parent=$.isNumeric(index)?$(node):$(node).parent();offset=0;merging=!1;$parent.contents().each(function(i,child){if(node===child||index===i&&0===i)return!1;if(child.nodeType===Node.TEXT_NODE){if(!merging&&0<child.nodeValue.length){offset+=1;merging=!0}}else{offset+=1;merging=!1}return index-1!==i&&null});return offset};UndoManager.prototype._getPosition=function(type){var $nodes,node,nodes,offset,position,prevNode,_this;null==type&&(type="start");offset=this.editor.selection.range()[type+"Offset"];if((node=($nodes=this.editor.selection[type+"Nodes"]()).first()[0]).nodeType===Node.TEXT_NODE){prevNode=node.previousSibling;for(;prevNode&&prevNode.nodeType===Node.TEXT_NODE;){node=prevNode;offset+=this.editor.util.getNodeLength(prevNode);prevNode=prevNode.previousSibling}(nodes=$nodes.get())[0]=node;$nodes=$(nodes)}else offset=this._getNodeOffset(node,offset);position=[offset];$nodes.each((_this=this,function(i,node){return position.unshift(_this._getNodeOffset(node))}));return position};UndoManager.prototype._getNodeByPosition=function(position){var child,childNodes,i,k,len,node,offset,ref;node=this.editor.body[0];for(i=k=0,len=(ref=position.slice(0,position.length-1)).length;k<len;i=++k){if((offset=ref[i])>(childNodes=node.childNodes).length-1){if(i!==position.length-2||!$(node).is(":empty")){node=null;break}child=document.createTextNode("");node.appendChild(child);childNodes=node.childNodes}node=childNodes[offset]}return node};UndoManager.prototype.caretPosition=function(caret){var endContainer,endOffset,range,startContainer,startOffset;if(caret){if(!caret.start)return;startContainer=this._getNodeByPosition(caret.start);startOffset=caret.start[caret.start.length-1];if(caret.collapsed){endContainer=startContainer;endOffset=startOffset}else{endContainer=this._getNodeByPosition(caret.end);endOffset=caret.start[caret.start.length-1]}if(!startContainer||!endContainer){"undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("simditor: invalid caret state");return}(range=document.createRange()).setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);return this.editor.selection.range(range)}range=this.editor.selection.range();return caret=this.editor.inputManager.focused&&null!=range?{start:this.startPosition(),end:this.endPosition(),collapsed:range.collapsed}:{}};return UndoManager}();Util=function(superClass){extend(Util,SimpleModule);function Util(){return Util.__super__.constructor.apply(this,arguments)}Util.pluginName="Util";Util.prototype._init=function(){this.editor=this._module;if(this.browser.msie&&this.browser.version<11)return this.phBr=""};Util.prototype.phBr="<br/>";Util.prototype.os=function(){var os;os={};/Mac/.test(navigator.appVersion)?os.mac=!0:/Linux/.test(navigator.appVersion)?os.linux=!0:/Win/.test(navigator.appVersion)?os.win=!0:/X11/.test(navigator.appVersion)&&(os.unix=!0);/Mobi/.test(navigator.appVersion)&&(os.mobile=!0);return os}();Util.prototype.browser=function(){var chrome,edge,firefox,ie,ref,ref1,ref2,ref3,ref4,safari,ua;ua=navigator.userAgent;ie=/(msie|trident)/i.test(ua);chrome=/chrome|crios/i.test(ua);safari=/safari/i.test(ua)&&!chrome;firefox=/firefox/i.test(ua);edge=/edge/i.test(ua);return ie?{msie:!0,version:1*(null!=(ref=ua.match(/(msie |rv:)(\d+(\.\d+)?)/i))?ref[2]:void 0)}:edge?{edge:!0,webkit:!0,version:1*(null!=(ref1=ua.match(/edge\/(\d+(\.\d+)?)/i))?ref1[1]:void 0)}:chrome?{webkit:!0,chrome:!0,version:1*(null!=(ref2=ua.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?ref2[1]:void 0)}:safari?{webkit:!0,safari:!0,version:1*(null!=(ref3=ua.match(/version\/(\d+(\.\d+)?)/i))?ref3[1]:void 0)}:firefox?{mozilla:!0,firefox:!0,version:1*(null!=(ref4=ua.match(/firefox\/(\d+(\.\d+)?)/i))?ref4[1]:void 0)}:{}}();Util.prototype.support={onselectionchange:function(){var onselectionchange;if(void 0!==(onselectionchange=document.onselectionchange))try{document.onselectionchange=0;return null===document.onselectionchange}catch(_error){}finally{document.onselectionchange=onselectionchange}return!1}(),oninput:!/(msie|trident)/i.test(navigator.userAgent)};Util.prototype.reflow=function(el){null==el&&(el=document);return $(el)[0].offsetHeight};Util.prototype.metaKey=function(e){return/Mac/.test(navigator.userAgent)?e.metaKey:e.ctrlKey};Util.prototype.isEmptyNode=function(node){var $node;return($node=$(node)).is(":empty")||!$node.text()&&!$node.find(":not(br, span, div)").length};Util.prototype.isDecoratedNode=function(node){return $(node).is('[class^="simditor-"]')};Util.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","h5","table"];Util.prototype.isBlockNode=function(node){return!(!(node=$(node)[0])||3===node.nodeType)&&new RegExp("^("+this.blockNodes.join("|")+")$").test(node.nodeName.toLowerCase())};Util.prototype.getNodeLength=function(node){switch((node=$(node)[0]).nodeType){case 7:case 10:return 0;case 3:case 8:return node.length;default:return node.childNodes.length}};Util.prototype.dataURLtoBlob=function(dataURL){var BlobBuilder,arrayBuffer,bb,byteString,hasArrayBufferViewSupport,hasBlobConstructor,i,intArray,k,mimeString,ref;hasArrayBufferViewSupport=(hasBlobConstructor=window.Blob&&function(){try{return Boolean(new Blob)}catch(_error){_error;return!1}}())&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(_error){_error;return!1}}();BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(!((hasBlobConstructor||BlobBuilder)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;byteString=0<=dataURL.split(",")[0].indexOf("base64")?atob(dataURL.split(",")[1]):decodeURIComponent(dataURL.split(",")[1]);arrayBuffer=new ArrayBuffer(byteString.length);intArray=new Uint8Array(arrayBuffer);for(i=k=0,ref=byteString.length;0<=ref?k<=ref:ref<=k;i=0<=ref?++k:--k)intArray[i]=byteString.charCodeAt(i);mimeString=dataURL.split(",")[0].split(":")[1].split(";")[0];if(hasBlobConstructor)return new Blob([hasArrayBufferViewSupport?intArray:arrayBuffer],{type:mimeString});(bb=new BlobBuilder).append(arrayBuffer);return bb.getBlob(mimeString)};Util.prototype.throttle=function(func,wait){var args,call,ctx,last,rtn,throttled,timeoutID;timeoutID=last=0;ctx=args=rtn=null;call=function(){timeoutID=0;last=+new Date;rtn=func.apply(ctx,args);return args=ctx=null};(throttled=function(){var delta;ctx=this;args=arguments;delta=new Date-last;timeoutID||(wait<=delta?call():timeoutID=setTimeout(call,wait-delta));return rtn}).clear=function(){if(timeoutID){clearTimeout(timeoutID);return call()}};return throttled};Util.prototype.formatHTML=function(html){var cursor,lastMatch,level,match,re,repeatString,result,str;re=/<(\/?)(.+?)(\/?)>/g;result="";level=0;lastMatch=null;"  ";repeatString=function(str,n){return new Array(n+1).join(str)};for(;null!==(match=re.exec(html));){match.isBlockNode=-1<$.inArray(match[2],this.blockNodes);match.isStartTag="/"!==match[1]&&"/"!==match[3];match.isEndTag="/"===match[1]||"/"===match[3];cursor=lastMatch?lastMatch.index+lastMatch[0].length:0;0<(str=html.substring(cursor,match.index)).length&&$.trim(str)&&(result+=str);match.isBlockNode&&match.isEndTag&&!match.isStartTag&&(level-=1);if(match.isBlockNode&&match.isStartTag){lastMatch&&lastMatch.isBlockNode&&lastMatch.isEndTag||(result+="\n");result+=repeatString("  ",level)}result+=match[0];match.isBlockNode&&match.isEndTag&&(result+="\n");match.isBlockNode&&match.isStartTag&&(level+=1);lastMatch=match}return $.trim(result)};return Util}();Toolbar=function(superClass){extend(Toolbar,SimpleModule);function Toolbar(){return Toolbar.__super__.constructor.apply(this,arguments)}Toolbar.pluginName="Toolbar";Toolbar.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0};Toolbar.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'};Toolbar.prototype._init=function(){var floatInitialized,initToolbarFloat,toolbarHeight;this.editor=this._module;if(this.opts.toolbar){$.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]);this._render();this.list.on("click",function(e){return!1});this.wrapper.on("mousedown",(_this=this,function(e){return _this.list.find(".menu-on").removeClass(".menu-on")}));var _this;$(document).on("mousedown.simditor"+this.editor.id,function(_this){return function(e){return _this.list.find(".menu-on").removeClass(".menu-on")}}(this));if(!this.opts.toolbarHidden&&this.opts.toolbarFloat){this.wrapper.css("top",this.opts.toolbarFloatOffset);toolbarHeight=0;initToolbarFloat=function(_this){return function(){_this.wrapper.css("position","static");_this.wrapper.width("auto");_this.editor.util.reflow(_this.wrapper);_this.wrapper.width(_this.wrapper.outerWidth());_this.wrapper.css("left",_this.editor.util.os.mobile?_this.wrapper.position().left:_this.wrapper.offset().left);_this.wrapper.css("position","");toolbarHeight=_this.wrapper.outerHeight();_this.editor.placeholderEl.css("top",toolbarHeight);return!0}}(this);floatInitialized=null;$(window).on("resize.simditor-"+this.editor.id,function(e){return floatInitialized=initToolbarFloat()});$(window).on("scroll.simditor-"+this.editor.id,function(_this){return function(e){var bottomEdge,scrollTop,topEdge;if(_this.wrapper.is(":visible")){bottomEdge=(topEdge=_this.editor.wrapper.offset().top)+_this.editor.wrapper.outerHeight()-80;if((scrollTop=$(document).scrollTop()+_this.opts.toolbarFloatOffset)<=topEdge||bottomEdge<=scrollTop){_this.editor.wrapper.removeClass("toolbar-floating").css("padding-top","");if(_this.editor.util.os.mobile)return _this.wrapper.css("top",_this.opts.toolbarFloatOffset)}else{floatInitialized||(floatInitialized=initToolbarFloat());_this.editor.wrapper.addClass("toolbar-floating").css("padding-top",toolbarHeight);if(_this.editor.util.os.mobile)return _this.wrapper.css("top",scrollTop-topEdge+_this.opts.toolbarFloatOffset)}}}}(this))}this.editor.on("destroy",function(_this){return function(){return _this.buttons.length=0}}(this));return $(document).on("mousedown.simditor-"+this.editor.id,function(_this){return function(e){return _this.list.find("li.menu-on").removeClass("menu-on")}}(this))}};Toolbar.prototype._render=function(){var k,len,name,ref;this.buttons=[];this.wrapper=$(this._tpl.wrapper).prependTo(this.editor.wrapper);this.list=this.wrapper.find("ul");for(k=0,len=(ref=this.opts.toolbar).length;k<len;k++)if("|"!==(name=ref[k])){if(!this.constructor.buttons[name])throw new Error("simditor: invalid toolbar button "+name);this.buttons.push(new this.constructor.buttons[name]({editor:this.editor}))}else $(this._tpl.separator).appendTo(this.list);if(this.opts.toolbarHidden)return this.wrapper.hide()};Toolbar.prototype.findButton=function(name){var button;return null!=(button=this.list.find(".toolbar-item-"+name).data("button"))?button:null};Toolbar.addButton=function(btn){return this.buttons[btn.prototype.name]=btn};Toolbar.buttons={};return Toolbar}();Indentation=function(superClass){extend(Indentation,SimpleModule);function Indentation(){return Indentation.__super__.constructor.apply(this,arguments)}Indentation.pluginName="Indentation";Indentation.prototype.opts={tabIndent:!0};Indentation.prototype._init=function(){this.editor=this._module;return this.editor.keystroke.add("tab","*",(_this=this,function(e){var codeButton;codeButton=_this.editor.toolbar.findButton("code");if(_this.opts.tabIndent||codeButton&&codeButton.active)return _this.indent(e.shiftKey)}));var _this};Indentation.prototype.indent=function(isBackward){var $blockNodes,nodes,result,_this;this.editor.selection.startNodes();this.editor.selection.endNodes();$blockNodes=this.editor.selection.blockNodes();nodes=[];$blockNodes=$blockNodes.each(function(i,node){var include,j,k,len,n;include=!0;for(j=k=0,len=nodes.length;k<len;j=++k){n=nodes[j];if($.contains(node,n)){include=!1;break}if($.contains(n,node)){nodes.splice(j,1,node);include=!1;break}}if(include)return nodes.push(node)});$blockNodes=$(nodes);result=!1;$blockNodes.each((_this=this,function(i,blockEl){var r;if(r=isBackward?_this.outdentBlock(blockEl):_this.indentBlock(blockEl))return result=r}));return result};Indentation.prototype.indentBlock=function(blockEl){var $blockEl,$childList,$nextTd,$nextTr,$parentLi,$pre,$td,$tr,marginLeft,tagName;if(($blockEl=$(blockEl)).length){if($blockEl.is("pre")){if(!($pre=this.editor.selection.containerNode()).is($blockEl)&&!$pre.closest("pre").is($blockEl))return;this.indentText(this.editor.selection.range())}else if($blockEl.is("li")){if(($parentLi=$blockEl.prev("li")).length<1)return;this.editor.selection.save();tagName=$blockEl.parent()[0].tagName;0<($childList=$parentLi.children("ul, ol")).length?$childList.append($blockEl):$("<"+tagName+"/>").append($blockEl).appendTo($parentLi);this.editor.selection.restore()}else if($blockEl.is("p, h1, h2, h3, h4")){marginLeft=parseInt($blockEl.css("margin-left"))||0;marginLeft=(Math.round(marginLeft/this.opts.indentWidth)+1)*this.opts.indentWidth;$blockEl.css("margin-left",marginLeft)}else{if(!$blockEl.is("table")&&!$blockEl.is(".simditor-table"))return!1;if(!(0<($nextTd=($td=this.editor.selection.containerNode().closest("td, th")).next("td, th")).length)){($nextTr=($tr=$td.parent("tr")).next("tr")).length<1&&$tr.parent().is("thead")&&($nextTr=$tr.parent("thead").next("tbody").find("tr:first"));$nextTd=$nextTr.find("td:first, th:first")}if(!(0<$td.length&&0<$nextTd.length))return;this.editor.selection.setRangeAtEndOf($nextTd)}return!0}};Indentation.prototype.indentText=function(range){var text,textNode;text=range.toString().replace(/^(?=.+)/gm,"  ");textNode=document.createTextNode(text||"  ");range.deleteContents();range.insertNode(textNode);if(text){range.selectNode(textNode);return this.editor.selection.range(range)}return this.editor.selection.setRangeAfter(textNode)};Indentation.prototype.outdentBlock=function(blockEl){var $blockEl,$parent,$parentLi,$pre,$prevTd,$prevTr,$td,$tr,marginLeft,range;if(($blockEl=$(blockEl))&&0<$blockEl.length){if($blockEl.is("pre")){if(!($pre=this.editor.selection.containerNode()).is($blockEl)&&!$pre.closest("pre").is($blockEl))return;this.outdentText(range)}else if($blockEl.is("li")){$parentLi=($parent=$blockEl.parent()).parent("li");this.editor.selection.save();if($parentLi.length<1){(range=document.createRange()).setStartBefore($parent[0]);range.setEndBefore($blockEl[0]);$parent.before(range.extractContents());$("<p/>").insertBefore($parent).after($blockEl.children("ul, ol")).append($blockEl.contents());$blockEl.remove()}else{0<$blockEl.next("li").length&&$("<"+$parent[0].tagName+"/>").append($blockEl.nextAll("li")).appendTo($blockEl);$blockEl.insertAfter($parentLi);$parent.children("li").length<1&&$parent.remove()}this.editor.selection.restore()}else if($blockEl.is("p, h1, h2, h3, h4")){marginLeft=parseInt($blockEl.css("margin-left"))||0;marginLeft=Math.max(Math.round(marginLeft/this.opts.indentWidth)-1,0)*this.opts.indentWidth;$blockEl.css("margin-left",0===marginLeft?"":marginLeft)}else{if(!$blockEl.is("table")&&!$blockEl.is(".simditor-table"))return!1;if(!(0<($prevTd=($td=this.editor.selection.containerNode().closest("td, th")).prev("td, th")).length)){($prevTr=($tr=$td.parent("tr")).prev("tr")).length<1&&$tr.parent().is("tbody")&&($prevTr=$tr.parent("tbody").prev("thead").find("tr:first"));$prevTd=$prevTr.find("td:last, th:last")}if(!(0<$td.length&&0<$prevTd.length))return;this.editor.selection.setRangeAtEndOf($prevTd)}return!0}};Indentation.prototype.outdentText=function(range){};return Indentation}();Clipboard=function(superClass){extend(Clipboard,SimpleModule);function Clipboard(){return Clipboard.__super__.constructor.apply(this,arguments)}Clipboard.pluginName="Clipboard";Clipboard.prototype.opts={pasteImage:!1,cleanPaste:!1};Clipboard.prototype._init=function(){this.editor=this._module;this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline");return this.editor.body.on("paste",(_this=this,function(e){var range;if(!_this.pasting&&!_this._pasteBin){if(!1===_this.editor.triggerHandler(e))return!1;range=_this.editor.selection.deleteRangeContents();if(_this.editor.body.html())range.collapsed||range.collapse(!0);else{_this.editor.formatter.format();_this.editor.selection.setRangeAtStartOf(_this.editor.body.find("p:first"))}if(_this._processPasteByClipboardApi(e))return!1;_this.editor.inputManager.throttledValueChanged.clear();_this.editor.inputManager.throttledSelectionChanged.clear();_this.editor.undoManager.throttledPushState.clear();_this.editor.selection.reset();_this.editor.undoManager.resetCaretPosition();_this.pasting=!0;return _this._getPasteContent(function(pasteContent){_this._processPasteContent(pasteContent);_this._pasteInBlockEl=null;_this._pastePlainText=null;return _this.pasting=!1})}}));var _this};Clipboard.prototype._processPasteByClipboardApi=function(e){var imageFile,pasteItem,ref,uploadOpt;if(!this.editor.util.browser.edge&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items&&0<e.originalEvent.clipboardData.items.length){pasteItem=e.originalEvent.clipboardData.items[0];if(/^image\//.test(pasteItem.type)){if(null==(imageFile=pasteItem.getAsFile())||!this.opts.pasteImage)return;imageFile.name||(imageFile.name="Clipboard Image.png");if(!1===this.editor.triggerHandler("pasting",[imageFile]))return;(uploadOpt={})[this.opts.pasteImage]=!0;null!=(ref=this.editor.uploader)&&ref.upload(imageFile,uploadOpt);return!0}}};Clipboard.prototype._getPasteContent=function(callback){var state,_this;this._pasteBin=$('<div contenteditable="true" />').addClass("simditor-paste-bin").attr("tabIndex","-1").appendTo(this.editor.el);state={html:this.editor.body.html(),caret:this.editor.undoManager.caretPosition()};this._pasteBin.focus();return setTimeout((_this=this,function(){var pasteContent;_this.editor.hidePopover();_this.editor.body.get(0).innerHTML=DOMPurify?DOMPurify.sanitize(state.html):state.html;_this.editor.undoManager.caretPosition(state.caret);_this.editor.body.focus();_this.editor.selection.reset();_this.editor.selection.range();_this._pasteInBlockEl=_this.editor.selection.blockNodes().last();_this._pastePlainText=_this.opts.cleanPaste||_this._pasteInBlockEl.is("pre, table");if(_this._pastePlainText)pasteContent=_this.editor.formatter.clearHtml(_this._pasteBin.html(),!0);else{(pasteContent=$("<div/>").append(_this._pasteBin.contents())).find("style").remove();pasteContent.find("table colgroup").remove();_this._cleanPasteFontSize(pasteContent);_this.editor.formatter.format(pasteContent);_this.editor.formatter.decorate(pasteContent);_this.editor.formatter.beautify(pasteContent.children());pasteContent=pasteContent.contents()}_this._pasteBin.remove();_this._pasteBin=null;return callback(pasteContent)}),0)};Clipboard.prototype._processPasteContent=function(pasteContent){var $blockEl,$img,blob,children,dataURLtoBlob,img,insertPosition,k,l,lastLine,len,len1,len2,len3,len4,line,lines,m,node,o,q,ref,ref1,ref2,uploadOpt,uploader;if(!1!==this.editor.triggerHandler("pasting",[pasteContent])){$blockEl=this._pasteInBlockEl;if(pasteContent){if(this._pastePlainText)if($blockEl.is("table")){lastLine=(lines=pasteContent.split("\n")).pop();for(k=0,len=lines.length;k<len;k++){line=lines[k];this.editor.selection.insertNode(document.createTextNode(line));this.editor.selection.insertNode($("<br/>"))}this.editor.selection.insertNode(document.createTextNode(lastLine))}else for(l=0,len1=(ref=(pasteContent=$("<div/>").text(pasteContent)).contents()).length;l<len1;l++){node=ref[l];this.editor.selection.insertNode($(node)[0])}else if($blockEl.is(this.editor.body))for(m=0,len2=pasteContent.length;m<len2;m++){node=pasteContent[m];this.editor.selection.insertNode(node)}else{if(pasteContent.length<1)return;if(1===pasteContent.length)if(pasteContent.is("p")){children=pasteContent.contents();$blockEl.is("h1, h2, h3, h4, h5")&&children.length&&children.css("font-size","");if(1===children.length&&children.is("img")){if(/^data:image/.test(($img=children).attr("src"))){if(!this.opts.pasteImage)return;(blob=this.editor.util.dataURLtoBlob($img.attr("src"))).name="Clipboard Image.png";(uploadOpt={})[this.opts.pasteImage]=!0;null!=(ref1=this.editor.uploader)&&ref1.upload(blob,uploadOpt);return}if(new RegExp("^blob:"+location.origin+"/").test($img.attr("src"))){if(!this.opts.pasteImage)return;(uploadOpt={})[this.opts.pasteImage]=!0;dataURLtoBlob=this.editor.util.dataURLtoBlob;uploader=this.editor.uploader;(img=new Image).onload=function(){var canvas;(canvas=document.createElement("canvas")).width=img.naturalWidth;canvas.height=img.naturalHeight;canvas.getContext("2d").drawImage(img,0,0);(blob=dataURLtoBlob(canvas.toDataURL("image/png"))).name="Clipboard Image.png";null!==uploader&&uploader.upload(blob,uploadOpt)};img.src=$img.attr("src");return}if($img.is('img[src^="webkit-fake-url://"]'))return}for(o=0,len3=children.length;o<len3;o++){node=children[o];this.editor.selection.insertNode(node)}}else if($blockEl.is("p")&&this.editor.util.isEmptyNode($blockEl)){$blockEl.replaceWith(pasteContent);this.editor.selection.setRangeAtEndOf(pasteContent)}else if(pasteContent.is("ul, ol"))if(1===pasteContent.find("li").length)for(q=0,len4=(ref2=(pasteContent=$("<div/>").text(pasteContent.text())).contents()).length;q<len4;q++){node=ref2[q];this.editor.selection.insertNode($(node)[0])}else if($blockEl.is("li")){$blockEl.parent().after(pasteContent);this.editor.selection.setRangeAtEndOf(pasteContent)}else{$blockEl.after(pasteContent);this.editor.selection.setRangeAtEndOf(pasteContent)}else{$blockEl.after(pasteContent);this.editor.selection.setRangeAtEndOf(pasteContent)}else{$blockEl.is("li")&&($blockEl=$blockEl.parent());if(this.editor.selection.rangeAtStartOf($blockEl))insertPosition="before";else if(this.editor.selection.rangeAtEndOf($blockEl))insertPosition="after";else{this.editor.selection.breakBlockEl($blockEl);insertPosition="before"}$blockEl[insertPosition](pasteContent);this.editor.selection.setRangeAtEndOf(pasteContent.last())}}return this.editor.inputManager.throttledValueChanged()}}};Clipboard.prototype._cleanPasteFontSize=function(node){var $node,sizeMap;if(0<($node=$(node)).length){sizeMap=["1.5em","1.25em","0.75em","0.5em"];return $node.find('[style*="font-size"]').map(function(i,el){var $el;$el=$(el);if($.inArray($el.css("font-size"),sizeMap)<0)return $el.css("font-size","")})}};return Clipboard}();(Simditor=function(superClass){extend(Simditor,SimpleModule);function Simditor(){return Simditor.__super__.constructor.apply(this,arguments)}Simditor.connect(Util);Simditor.connect(InputManager);Simditor.connect(Selection);Simditor.connect(UndoManager);Simditor.connect(Keystroke);Simditor.connect(Formatter);Simditor.connect(Toolbar);Simditor.connect(Indentation);Simditor.connect(Clipboard);Simditor.count=0;Simditor.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,indentWidth:40};Simditor.prototype._init=function(){var editor,uploadOpts,_this;this.textarea=$(this.opts.textarea);this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder");if(!this.textarea.length)throw new Error("simditor: param textarea is required.");null!=(editor=this.textarea.data("simditor"))&&editor.destroy();this.id=++Simditor.count;this._render();if(!simpleHotkeys)throw new Error("simditor: simple-hotkeys is required.");this.hotkeys=simpleHotkeys({el:this.body});if(this.opts.upload&&simpleUploader){uploadOpts="object"==typeof this.opts.upload?this.opts.upload:{};this.uploader=simpleUploader(uploadOpts)}this.on("initialized",(_this=this,function(){_this.opts.placeholder&&_this.on("valuechanged",function(){return _this._placeholder()});_this.setValue(_this.textarea.val().trim()||"");if(_this.textarea.attr("autofocus"))return _this.focus()}));if(this.util.browser.mozilla){this.util.reflow();try{document.execCommand("enableObjectResizing",!1,!1);return document.execCommand("enableInlineTableEditing",!1,!1)}catch(_error){_error}}};Simditor.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>';Simditor.prototype._render=function(){var key,ref,results,val;this.el=$(this._tpl).insertBefore(this.textarea);this.wrapper=this.el.find(".simditor-wrapper");this.body=this.wrapper.find(".simditor-body");this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder);this.el.data("simditor",this);this.wrapper.append(this.textarea);this.textarea.data("simditor",this).blur();this.body.attr("tabindex",this.textarea.attr("tabindex"));this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux");this.util.os.mobile&&this.el.addClass("simditor-mobile");if(this.opts.params){ref=this.opts.params;results=[];for(key in ref){val=ref[key];results.push($("<input/>",{type:"hidden",name:key,value:val}).insertAfter(this.textarea))}return results}};Simditor.prototype._placeholder=function(){var children;return 0===(children=this.body.children()).length||1===children.length&&this.util.isEmptyNode(children)&&parseInt(children.css("margin-left")||0)<this.opts.indentWidth?this.placeholderEl.show():this.placeholderEl.hide()};Simditor.prototype.setValue=function(val){this.hidePopover();this.textarea.val(val);this.body.get(0).innerHTML=DOMPurify?DOMPurify.sanitize(val):val;this.formatter.format();this.formatter.decorate();this.util.reflow(this.body);this.inputManager.lastCaretPosition=null;return this.trigger("valuechanged")};Simditor.prototype.getValue=function(){return this.sync()};Simditor.prototype.sync=function(){var children,cloneBody,emptyP,firstP,lastP,val;cloneBody=this.body.clone();this.formatter.undecorate(cloneBody);this.formatter.format(cloneBody);this.formatter.autolink(cloneBody);lastP=(children=cloneBody.children()).last("p");firstP=children.first("p");for(;lastP.is("p")&&this.util.isEmptyNode(lastP);){lastP=(emptyP=lastP).prev("p");emptyP.remove()}for(;firstP.is("p")&&this.util.isEmptyNode(firstP);){emptyP=firstP;firstP=lastP.next("p");emptyP.remove()}cloneBody.find("img.uploading").remove();val=$.trim(cloneBody.html());this.textarea.val(val);return val};Simditor.prototype.focus=function(){var $blockEl,range;if(this.body.is(":visible")&&this.body.is("[contenteditable]")){if(this.inputManager.lastCaretPosition){this.undoManager.caretPosition(this.inputManager.lastCaretPosition);return this.inputManager.lastCaretPosition=null}($blockEl=this.body.children().last()).is("p")||($blockEl=$("<p/>").append(this.util.phBr).appendTo(this.body));range=document.createRange();return this.selection.setRangeAtEndOf($blockEl,range)}this.el.find("textarea:visible").focus()};Simditor.prototype.blur=function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()};Simditor.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(i,popover){if((popover=$(popover).data("popover")).active)return popover.hide()})};Simditor.prototype.destroy=function(){this.triggerHandler("destroy");this.textarea.closest("form").off(".simditor .simditor-"+this.id);this.selection.clear();this.inputManager.focused=!1;this.textarea.insertBefore(this.el).hide().val("").removeData("simditor");this.el.remove();$(document).off(".simditor-"+this.id);$(window).off(".simditor-"+this.id);return this.off()};return Simditor}()).i18n={"zh-CN":{blockquote:"引用",bold:"加粗文字",code:"插入代码",color:"文字颜色",coloredText:"彩色文字",hr:"分隔线",image:"插入图片",externalImage:"外链图片",uploadImage:"上传图片",uploadFailed:"上传失败了",uploadError:"上传出错了",imageUrl:"图片地址",imageSize:"图片尺寸",imageAlt:"图片描述",restoreImageSize:"还原图片尺寸",uploading:"正在上传",indent:"向右缩进",outdent:"向左缩进",italic:"斜体文字",link:"插入链接",linkText:"链接文字",linkUrl:"链接地址",linkTarget:"打开方式",openLinkInCurrentWindow:"在当前窗口中打开",openLinkInNewWindow:"在新窗口中打开",removeLink:"移除链接",ol:"有序列表",ul:"无序列表",strikethrough:"删除线文字",table:"表格",deleteRow:"删除行",insertRowAbove:"在上面插入行",insertRowBelow:"在下面插入行",deleteColumn:"删除列",insertColumnLeft:"在左边插入列",insertColumnRight:"在右边插入列",deleteTable:"删除表格",title:"标题",normalText:"普通文本",underline:"下划线文字",alignment:"水平对齐",alignCenter:"居中",alignLeft:"居左",alignRight:"居右",selectLanguage:"选择程序语言",fontScale:"字体大小",fontScaleXLarge:"超大字体",fontScaleLarge:"大号字体",fontScaleNormal:"正常大小",fontScaleSmall:"小号字体",fontScaleXSmall:"超小字体"},"en-US":{blockquote:"Block Quote",bold:"Bold",code:"Code",color:"Text Color",coloredText:"Colored Text",hr:"Horizontal Line",image:"Insert Image",externalImage:"External Image",uploadImage:"Upload Image",uploadFailed:"Upload failed",uploadError:"Error occurs during upload",imageUrl:"Url",imageSize:"Size",imageAlt:"Alt",restoreImageSize:"Restore Origin Size",uploading:"Uploading",indent:"Indent",outdent:"Outdent",italic:"Italic",link:"Insert Link",linkText:"Text",linkUrl:"Url",linkTarget:"Target",openLinkInCurrentWindow:"Open link in current window",openLinkInNewWindow:"Open link in new window",removeLink:"Remove Link",ol:"Ordered List",ul:"Unordered List",strikethrough:"Strikethrough",table:"Table",deleteRow:"Delete Row",insertRowAbove:"Insert Row Above",insertRowBelow:"Insert Row Below",deleteColumn:"Delete Column",insertColumnLeft:"Insert Column Left",insertColumnRight:"Insert Column Right",deleteTable:"Delete Table",title:"Title",normalText:"Text",underline:"Underline",alignment:"Alignment",alignCenter:"Align Center",alignLeft:"Align Left",alignRight:"Align Right",selectLanguage:"Select Language",fontScale:"Font Size",fontScaleXLarge:"X Large Size",fontScaleLarge:"Large Size",fontScaleNormal:"Normal Size",fontScaleSmall:"Small Size",fontScaleXSmall:"X Small Size"}};Button=function(superClass){extend(Button,SimpleModule);Button.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'};Button.prototype.name="";Button.prototype.icon="";Button.prototype.title="";Button.prototype.text="";Button.prototype.htmlTag="";Button.prototype.disableTag="";Button.prototype.menu=!1;Button.prototype.active=!1;Button.prototype.disabled=!1;Button.prototype.needFocus=!0;Button.prototype.shortcut=null;function Button(opts){this.editor=opts.editor;this.title=this._t(this.name);Button.__super__.constructor.call(this,opts)}Button.prototype._init=function(){var k,len,ref,tag,_this;this.render();this.el.on("mousedown",(_this=this,function(e){var noFocus,param;e.preventDefault();noFocus=_this.needFocus&&!_this.editor.inputManager.focused;if(_this.el.hasClass("disabled"))return!1;noFocus&&_this.editor.focus();if(_this.menu){_this.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on");if(_this.wrapper.is(".menu-on")){0<_this.menuWrapper.offset().left+_this.menuWrapper.outerWidth()+5-_this.editor.wrapper.offset().left-_this.editor.wrapper.outerWidth()&&_this.menuWrapper.css({left:"auto",right:0});_this.trigger("menuexpand")}return!1}param=_this.el.data("param");_this.command(param);return!1}));this.wrapper.on("click","a.menu-item",function(_this){return function(e){var btn,noFocus,param;e.preventDefault();btn=$(e.currentTarget);_this.wrapper.removeClass("menu-on");noFocus=_this.needFocus&&!_this.editor.inputManager.focused;if(btn.hasClass("disabled")||noFocus)return!1;_this.editor.toolbar.wrapper.removeClass("menu-on");param=btn.data("param");_this.command(param);return!1}}(this));this.wrapper.on("mousedown","a.menu-item",function(e){return!1});this.editor.on("blur",function(_this){return function(){if(_this.editor.body.is(":visible")&&_this.editor.body.is("[contenteditable]")&&!_this.editor.clipboard.pasting){_this.setActive(!1);return _this.setDisabled(!1)}}}(this));null!=this.shortcut&&this.editor.hotkeys.add(this.shortcut,function(_this){return function(e){_this.el.mousedown();return!1}}(this));for(k=0,len=(ref=this.htmlTag.split(",")).length;k<len;k++){tag=ref[k];(tag=$.trim(tag))&&$.inArray(tag,this.editor.formatter._allowedTags)<0&&this.editor.formatter._allowedTags.push(tag)}return this.editor.on("selectionchanged",function(_this){return function(e){if(_this.editor.inputManager.focused)return _this._status()}}(this))};Button.prototype.iconClassOf=function(icon){return icon?"simditor-icon simditor-icon-"+icon:""};Button.prototype.setIcon=function(icon){return this.el.find("span").removeClass().addClass(this.iconClassOf(icon)).text(this.text)};Button.prototype.render=function(){this.wrapper=$(this._tpl.item).appendTo(this.editor.toolbar.list);this.el=this.wrapper.find("a.toolbar-item");this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this);this.setIcon(this.icon);if(this.menu){this.menuWrapper=$(this._tpl.menuWrapper).appendTo(this.wrapper);this.menuWrapper.addClass("toolbar-menu-"+this.name);return this.renderMenu()}};Button.prototype.renderMenu=function(){var $menuBtnEl,k,len,menuItem,ref,ref1,results;if($.isArray(this.menu)){this.menuEl=$("<ul/>").appendTo(this.menuWrapper);results=[];for(k=0,len=(ref=this.menu).length;k<len;k++)if("|"!==(menuItem=ref[k])){$menuBtnEl=$(this._tpl.menuItem).appendTo(this.menuEl).find("a.menu-item").attr({title:null!=(ref1=menuItem.title)?ref1:menuItem.text,"data-param":menuItem.param}).addClass("menu-item-"+menuItem.name);menuItem.icon?results.push($menuBtnEl.find("span").addClass(this.iconClassOf(menuItem.icon))):results.push($menuBtnEl.find("span").text(menuItem.text))}else $(this._tpl.separator).appendTo(this.menuEl);return results}};Button.prototype.setActive=function(active){if(active!==this.active){this.active=active;return this.el.toggleClass("active",this.active)}};Button.prototype.setDisabled=function(disabled){if(disabled!==this.disabled){this.disabled=disabled;return this.el.toggleClass("disabled",this.disabled)}};Button.prototype._disableStatus=function(){var disabled,endNodes,startNodes;startNodes=this.editor.selection.startNodes();endNodes=this.editor.selection.endNodes();disabled=0<startNodes.filter(this.disableTag).length||0<endNodes.filter(this.disableTag).length;this.setDisabled(disabled);this.disabled&&this.setActive(!1);return this.disabled};Button.prototype._activeStatus=function(){var active,endNode,endNodes,startNode,startNodes;startNodes=this.editor.selection.startNodes();endNodes=this.editor.selection.endNodes();startNode=startNodes.filter(this.htmlTag);endNode=endNodes.filter(this.htmlTag);active=0<startNode.length&&0<endNode.length&&startNode.is(endNode);this.node=active?startNode:null;this.setActive(active);return this.active};Button.prototype._status=function(){this._disableStatus();if(!this.disabled)return this._activeStatus()};Button.prototype.command=function(param){};Button.prototype._t=function(){var args,ref,result;args=1<=arguments.length?slice.call(arguments,0):[];(result=Button.__super__._t.apply(this,args))||(result=(ref=this.editor)._t.apply(ref,args));return result};return Button}();Simditor.Button=Button;Popover=function(superClass){extend(Popover,SimpleModule);Popover.prototype.offset={top:4,left:0};Popover.prototype.target=null;Popover.prototype.active=!1;function Popover(opts){this.button=opts.button;this.editor=opts.button.editor;Popover.__super__.constructor.call(this,opts)}Popover.prototype._init=function(){this.el=$('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this);this.render();this.el.on("mouseenter",(_this=this,function(e){return _this.el.addClass("hover")}));var _this;return this.el.on("mouseleave",function(_this){return function(e){return _this.el.removeClass("hover")}}(this))};Popover.prototype.render=function(){};Popover.prototype._initLabelWidth=function(){var $fields;if(0<($fields=this.el.find(".settings-field")).length){this._labelWidth=0;$fields.each((_this=this,function(i,field){var $label;if(0<($label=$(field).find("label")).length)return _this._labelWidth=Math.max(_this._labelWidth,$label.width())}));var _this;return $fields.find("label").width(this._labelWidth)}};Popover.prototype.show=function($target,position){null==position&&(position="bottom");if(null!=$target){this.el.siblings(".simditor-popover").each(function(i,popover){if((popover=$(popover).data("popover"))&&popover.active)return popover.hide()});this.active&&this.target&&this.target.removeClass("selected");this.target=$target.addClass("selected");if(this.active){this.refresh(position);return this.trigger("popovershow")}this.active=!0;this.el.css({left:-9999}).show();this._labelWidth||this._initLabelWidth();this.editor.util.reflow();this.refresh(position);return this.trigger("popovershow")}};Popover.prototype.hide=function(){if(this.active){this.target&&this.target.removeClass("selected");this.target=null;this.active=!1;this.el.hide();return this.trigger("popoverhide")}};Popover.prototype.refresh=function(position){var editorOffset,left,maxLeft,targetH,targetOffset,top;null==position&&(position="bottom");if(this.active){editorOffset=this.editor.el.offset();targetOffset=this.target.offset();targetH=this.target.outerHeight();"bottom"===position?top=targetOffset.top-editorOffset.top+targetH:"top"===position&&(top=targetOffset.top-editorOffset.top-this.el.height());maxLeft=this.editor.wrapper.width()-this.el.outerWidth()-10;left=Math.min(targetOffset.left-editorOffset.left,maxLeft);return this.el.css({top:top+this.offset.top,left:left+this.offset.left})}};Popover.prototype.destroy=function(){this.target=null;this.active=!1;this.editor.off(".linkpopover");return this.el.remove()};Popover.prototype._t=function(){var args,ref,result;args=1<=arguments.length?slice.call(arguments,0):[];(result=Popover.__super__._t.apply(this,args))||(result=(ref=this.button)._t.apply(ref,args));return result};return Popover}();Simditor.Popover=Popover;TitleButton=function(superClass){extend(TitleButton,Button);function TitleButton(){return TitleButton.__super__.constructor.apply(this,arguments)}TitleButton.prototype.name="title";TitleButton.prototype.htmlTag="h1, h2, h3, h4, h5";TitleButton.prototype.disableTag="pre, table";TitleButton.prototype._init=function(){this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}];return TitleButton.__super__._init.call(this)};TitleButton.prototype.setActive=function(active,param){TitleButton.__super__.setActive.call(this,active);active&&(param||(param=this.node[0].tagName.toLowerCase()));this.el.removeClass("active-p active-h1 active-h2 active-h3 active-h4 active-h5");if(active)return this.el.addClass("active active-"+param)};TitleButton.prototype.command=function(param){var $rootNodes,_this;$rootNodes=this.editor.selection.rootNodes();this.editor.selection.save();$rootNodes.each((_this=this,function(i,node){var $node;if(!(($node=$(node)).is("blockquote")||$node.is(param)||$node.is(_this.disableTag)||_this.editor.util.isDecoratedNode($node)))return $("<"+param+"/>").append($node.contents()).replaceAll($node)}));this.editor.selection.restore();return this.editor.trigger("valuechanged")};return TitleButton}();Simditor.Toolbar.addButton(TitleButton);FontScaleButton=function(superClass){extend(FontScaleButton,Button);function FontScaleButton(){return FontScaleButton.__super__.constructor.apply(this,arguments)}FontScaleButton.prototype.name="fontScale";FontScaleButton.prototype.icon="font";FontScaleButton.prototype.htmlTag="span";FontScaleButton.prototype.disableTag="pre, h1, h2, h3, h4, h5";FontScaleButton.prototype.sizeMap={"x-large":"1.5em",large:"1.25em",small:".75em","x-small":".5em"};FontScaleButton.prototype._init=function(){this.menu=[{name:"150%",text:this._t("fontScaleXLarge"),param:"5"},{name:"125%",text:this._t("fontScaleLarge"),param:"4"},{name:"100%",text:this._t("fontScaleNormal"),param:"3"},{name:"75%",text:this._t("fontScaleSmall"),param:"2"},{name:"50%",text:this._t("fontScaleXSmall"),param:"1"}];return FontScaleButton.__super__._init.call(this)};FontScaleButton.prototype._activeStatus=function(){var active,endNode,endNodes,startNode,startNodes;this.editor.selection.range();startNodes=this.editor.selection.startNodes();endNodes=this.editor.selection.endNodes();startNode=startNodes.filter('span[style*="font-size"]');endNode=endNodes.filter('span[style*="font-size"]');active=0<startNodes.length&&0<endNodes.length&&startNode.is(endNode);this.setActive(active);return this.active};FontScaleButton.prototype.command=function(param){var containerNode,range;if(!(range=this.editor.selection.range()).collapsed){this.editor.selection.range(range);document.execCommand("styleWithCSS",!1,!0);document.execCommand("fontSize",!1,param);document.execCommand("styleWithCSS",!1,!1);this.editor.selection.reset();this.editor.selection.range();((containerNode=this.editor.selection.containerNode())[0].nodeType===Node.TEXT_NODE?containerNode.closest('span[style*="font-size"]'):containerNode.find('span[style*="font-size"]')).each((_this=this,function(i,n){var $span,size;$span=$(n);size=n.style.fontSize;return/large|x-large|small|x-small/.test(size)?$span.css("fontSize",_this.sizeMap[size]):"medium"===size?1<$span[0].style.length?$span.css("fontSize",""):$span.replaceWith($span.contents()):void 0}));var _this;return this.editor.trigger("valuechanged")}};return FontScaleButton}();Simditor.Toolbar.addButton(FontScaleButton);BoldButton=function(superClass){extend(BoldButton,Button);function BoldButton(){return BoldButton.__super__.constructor.apply(this,arguments)}BoldButton.prototype.name="bold";BoldButton.prototype.icon="bold";BoldButton.prototype.htmlTag="b, strong";BoldButton.prototype.disableTag="pre";BoldButton.prototype.shortcut="cmd+b";BoldButton.prototype._init=function(){if(this.editor.util.os.mac)this.title=this.title+" ( Cmd + b )";else{this.title=this.title+" ( Ctrl + b )";this.shortcut="ctrl+b"}return BoldButton.__super__._init.call(this)};BoldButton.prototype._activeStatus=function(){var active;active=!0===document.queryCommandState("bold");this.setActive(active);return this.active};BoldButton.prototype.command=function(){document.execCommand("bold");this.editor.util.support.oninput||this.editor.trigger("valuechanged");return $(document).trigger("selectionchange")};return BoldButton}();Simditor.Toolbar.addButton(BoldButton);ItalicButton=function(superClass){extend(ItalicButton,Button);function ItalicButton(){return ItalicButton.__super__.constructor.apply(this,arguments)}ItalicButton.prototype.name="italic";ItalicButton.prototype.icon="italic";ItalicButton.prototype.htmlTag="i";ItalicButton.prototype.disableTag="pre";ItalicButton.prototype.shortcut="cmd+i";ItalicButton.prototype._init=function(){if(this.editor.util.os.mac)this.title=this.title+" ( Cmd + i )";else{this.title=this.title+" ( Ctrl + i )";this.shortcut="ctrl+i"}return ItalicButton.__super__._init.call(this)};ItalicButton.prototype._activeStatus=function(){var active;active=!0===document.queryCommandState("italic");this.setActive(active);return this.active};ItalicButton.prototype.command=function(){document.execCommand("italic");this.editor.util.support.oninput||this.editor.trigger("valuechanged");return $(document).trigger("selectionchange")};return ItalicButton}();Simditor.Toolbar.addButton(ItalicButton);UnderlineButton=function(superClass){extend(UnderlineButton,Button);function UnderlineButton(){return UnderlineButton.__super__.constructor.apply(this,arguments)}UnderlineButton.prototype.name="underline";UnderlineButton.prototype.icon="underline";UnderlineButton.prototype.htmlTag="u";UnderlineButton.prototype.disableTag="pre";UnderlineButton.prototype.shortcut="cmd+u";UnderlineButton.prototype.render=function(){if(this.editor.util.os.mac)this.title=this.title+" ( Cmd + u )";else{this.title=this.title+" ( Ctrl + u )";this.shortcut="ctrl+u"}return UnderlineButton.__super__.render.call(this)};UnderlineButton.prototype._activeStatus=function(){var active;active=!0===document.queryCommandState("underline");this.setActive(active);return this.active};UnderlineButton.prototype.command=function(){document.execCommand("underline");this.editor.util.support.oninput||this.editor.trigger("valuechanged");return $(document).trigger("selectionchange")};return UnderlineButton}();Simditor.Toolbar.addButton(UnderlineButton);ColorButton=function(superClass){extend(ColorButton,Button);function ColorButton(){return ColorButton.__super__.constructor.apply(this,arguments)}ColorButton.prototype.name="color";ColorButton.prototype.icon="tint";ColorButton.prototype.disableTag="pre";ColorButton.prototype.menu=!0;ColorButton.prototype.render=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return ColorButton.__super__.render.apply(this,args)};ColorButton.prototype.renderMenu=function(){$('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default"></a></li>\n</ul>').appendTo(this.menuWrapper);this.menuWrapper.on("mousedown",".color-list",function(e){return!1});return this.menuWrapper.on("click",".font-color",(_this=this,function(e){var $link,$p,hex,range,rgb,textNode;_this.wrapper.removeClass("menu-on");if(($link=$(e.currentTarget)).hasClass("font-color-default")){if(!(0<($p=_this.editor.body.find("p, li")).length))return;rgb=window.getComputedStyle($p[0],null).getPropertyValue("color");hex=_this._convertRgbToHex(rgb)}else{rgb=window.getComputedStyle($link[0],null).getPropertyValue("background-color");hex=_this._convertRgbToHex(rgb)}if(hex){range=_this.editor.selection.range();if(!$link.hasClass("font-color-default")&&range.collapsed){textNode=document.createTextNode(_this._t("coloredText"));range.insertNode(textNode);range.selectNodeContents(textNode)}_this.editor.selection.range(range);document.execCommand("styleWithCSS",!1,!0);document.execCommand("foreColor",!1,hex);document.execCommand("styleWithCSS",!1,!1);return _this.editor.util.support.oninput?void 0:_this.editor.trigger("valuechanged")}}));var _this};ColorButton.prototype._convertRgbToHex=function(rgb){var match;return(match=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g.exec(rgb))?function(r,g,b){var componentToHex;return"#"+(componentToHex=function(c){var hex;return 1===(hex=c.toString(16)).length?"0"+hex:hex})(r)+componentToHex(g)+componentToHex(b)}(1*match[1],1*match[2],1*match[3]):""};return ColorButton}();Simditor.Toolbar.addButton(ColorButton);ListButton=function(superClass){extend(ListButton,Button);function ListButton(){return ListButton.__super__.constructor.apply(this,arguments)}ListButton.prototype.type="";ListButton.prototype.disableTag="pre, table";ListButton.prototype.command=function(param){var $list,$rootNodes,anotherType,_this;$rootNodes=this.editor.selection.blockNodes();anotherType="ul"===this.type?"ol":"ul";this.editor.selection.save();$list=null;$rootNodes.each((_this=this,function(i,node){var $node;if(!(($node=$(node)).is("blockquote, li")||$node.is(_this.disableTag)||_this.editor.util.isDecoratedNode($node))&&$.contains(document,node)){if($node.is(_this.type)){$node.children("li").each(function(i,li){$(li).children("ul, ol").insertAfter($node);return $("<p/>").append($(li).html()||_this.editor.util.phBr).insertBefore($node)});return $node.remove()}if($node.is(anotherType))return $("<"+_this.type+"/>").append($node.contents()).replaceAll($node);if($list&&$node.prev().is($list)){$("<li/>").append($node.html()||_this.editor.util.phBr).appendTo($list);return $node.remove()}($list=$("<"+_this.type+"><li></li></"+_this.type+">")).find("li").append($node.html()||_this.editor.util.phBr);return $list.replaceAll($node)}}));this.editor.selection.restore();return this.editor.trigger("valuechanged")};return ListButton}();OrderListButton=function(superClass){extend(OrderListButton,ListButton);function OrderListButton(){return OrderListButton.__super__.constructor.apply(this,arguments)}OrderListButton.prototype.type="ol";OrderListButton.prototype.name="ol";OrderListButton.prototype.icon="list-ol";OrderListButton.prototype.htmlTag="ol";OrderListButton.prototype.shortcut="cmd+/";OrderListButton.prototype._init=function(){if(this.editor.util.os.mac)this.title=this.title+" ( Cmd + / )";else{this.title=this.title+" ( ctrl + / )";this.shortcut="ctrl+/"}return OrderListButton.__super__._init.call(this)};return OrderListButton}();UnorderListButton=function(superClass){extend(UnorderListButton,ListButton);function UnorderListButton(){return UnorderListButton.__super__.constructor.apply(this,arguments)}UnorderListButton.prototype.type="ul";UnorderListButton.prototype.name="ul";UnorderListButton.prototype.icon="list-ul";UnorderListButton.prototype.htmlTag="ul";UnorderListButton.prototype.shortcut="cmd+.";UnorderListButton.prototype._init=function(){if(this.editor.util.os.mac)this.title=this.title+" ( Cmd + . )";else{this.title=this.title+" ( Ctrl + . )";this.shortcut="ctrl+."}return UnorderListButton.__super__._init.call(this)};return UnorderListButton}();Simditor.Toolbar.addButton(OrderListButton);Simditor.Toolbar.addButton(UnorderListButton);BlockquoteButton=function(superClass){extend(BlockquoteButton,Button);function BlockquoteButton(){return BlockquoteButton.__super__.constructor.apply(this,arguments)}BlockquoteButton.prototype.name="blockquote";BlockquoteButton.prototype.icon="quote-left";BlockquoteButton.prototype.htmlTag="blockquote";BlockquoteButton.prototype.disableTag="pre, table";BlockquoteButton.prototype.command=function(){var $rootNodes,clearCache,nodeCache,_this;$rootNodes=($rootNodes=this.editor.selection.rootNodes()).filter(function(i,node){return!$(node).parent().is("blockquote")});this.editor.selection.save();nodeCache=[];clearCache=(_this=this,function(){if(0<nodeCache.length){$("<"+_this.htmlTag+"/>").insertBefore(nodeCache[0]).append(nodeCache);return nodeCache.length=0}});$rootNodes.each(function(_this){return function(i,node){var $node;if(($node=$(node)).parent().is(_this.editor.body)){if($node.is(_this.htmlTag)){clearCache();return $node.children().unwrap()}return $node.is(_this.disableTag)||_this.editor.util.isDecoratedNode($node)?clearCache():nodeCache.push(node)}}}(this));clearCache();this.editor.selection.restore();return this.editor.trigger("valuechanged")};return BlockquoteButton}();Simditor.Toolbar.addButton(BlockquoteButton);CodeButton=function(superClass){extend(CodeButton,Button);function CodeButton(){return CodeButton.__super__.constructor.apply(this,arguments)}CodeButton.prototype.name="code";CodeButton.prototype.icon="code";CodeButton.prototype.htmlTag="pre";CodeButton.prototype.disableTag="ul, ol, table";CodeButton.prototype._init=function(){CodeButton.__super__._init.call(this);this.editor.on("decorate",(_this=this,function(e,$el){return $el.find("pre").each(function(i,pre){return _this.decorate($(pre))})}));var _this;return this.editor.on("undecorate",function(_this){return function(e,$el){return $el.find("pre").each(function(i,pre){return _this.undecorate($(pre))})}}(this))};CodeButton.prototype.render=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];CodeButton.__super__.render.apply(this,args);return this.popover=new CodePopover({button:this})};CodeButton.prototype._checkMode=function(){var range;range=this.editor.selection.range();if(0<$(range.cloneContents()).find(this.editor.util.blockNodes.join(","))||range.collapsed&&0===this.editor.selection.startNodes().filter("code").length){this.inlineMode=!1;return this.htmlTag="pre"}this.inlineMode=!0;return this.htmlTag="code"};CodeButton.prototype._status=function(){this._checkMode();CodeButton.__super__._status.call(this);if(!this.inlineMode)return this.active?this.popover.show(this.node):this.popover.hide()};CodeButton.prototype.decorate=function($pre){var $code,lang,ref,ref1;if(0<($code=$pre.find("> code")).length){lang=null!=(ref=$code.attr("class"))&&null!=(ref1=ref.match(/lang-(\S+)/))?ref1[1]:void 0;$code.contents().unwrap();if(lang)return $pre.attr("data-lang",lang)}};CodeButton.prototype.undecorate=function($pre){var $code,lang;lang=$pre.attr("data-lang");$code=$("<code/>");lang&&-1!==lang&&$code.addClass("lang-"+lang);return $pre.wrapInner($code).removeAttr("data-lang")};CodeButton.prototype.command=function(){return this.inlineMode?this._inlineCommand():this._blockCommand()};CodeButton.prototype._blockCommand=function(){var $rootNodes,clearCache,nodeCache,resultNodes,_this;$rootNodes=this.editor.selection.rootNodes();nodeCache=[];resultNodes=[];clearCache=(_this=this,function(){var $pre;if(0<nodeCache.length){$pre=$("<"+_this.htmlTag+"/>").insertBefore(nodeCache[0]).text(_this.editor.formatter.clearHtml(nodeCache));resultNodes.push($pre[0]);return nodeCache.length=0}});$rootNodes.each(function(_this){return function(i,node){var $node,$p;if(($node=$(node)).is(_this.htmlTag)){clearCache();$p=$("<p/>").append($node.html().replace("\n","<br/>")).replaceAll($node);return resultNodes.push($p[0])}return $node.is(_this.disableTag)||_this.editor.util.isDecoratedNode($node)||$node.is("blockquote")?clearCache():nodeCache.push(node)}}(this));clearCache();this.editor.selection.setRangeAtEndOf($(resultNodes).last());return this.editor.trigger("valuechanged")};CodeButton.prototype._inlineCommand=function(){var $code,$contents,range;range=this.editor.selection.range();if(this.active){range.selectNodeContents(this.node[0]);this.editor.selection.save(range);this.node.contents().unwrap();this.editor.selection.restore()}else{$contents=$(range.extractContents());$code=$("<"+this.htmlTag+"/>").append($contents.contents());range.insertNode($code[0]);range.selectNodeContents($code[0]);this.editor.selection.range(range)}return this.editor.trigger("valuechanged")};return CodeButton}();CodePopover=function(superClass){extend(CodePopover,Popover);function CodePopover(){return CodePopover.__super__.constructor.apply(this,arguments)}CodePopover.prototype.render=function(){var k,lang,len,ref,_this;this._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">'+this._t("selectLanguage")+"</option>\n    </select>\n  </div>\n</div>";this.langs=this.editor.opts.codeLanguages||[{name:"Bash",value:"bash"},{name:"C++",value:"c++"},{name:"C#",value:"cs"},{name:"CSS",value:"css"},{name:"Erlang",value:"erlang"},{name:"Less",value:"less"},{name:"Sass",value:"sass"},{name:"Diff",value:"diff"},{name:"CoffeeScript",value:"coffeescript"},{name:"HTML,XML",value:"html"},{name:"JSON",value:"json"},{name:"Java",value:"java"},{name:"JavaScript",value:"js"},{name:"Markdown",value:"markdown"},{name:"Objective C",value:"oc"},{name:"PHP",value:"php"},{name:"Perl",value:"parl"},{name:"Python",value:"python"},{name:"Ruby",value:"ruby"},{name:"SQL",value:"sql"}];this.el.addClass("code-popover").append(this._tpl);this.selectEl=this.el.find(".select-lang");for(k=0,len=(ref=this.langs).length;k<len;k++){lang=ref[k];$("<option/>",{text:lang.name,value:lang.value}).appendTo(this.selectEl)}this.selectEl.on("change",(_this=this,function(e){var selected;_this.lang=_this.selectEl.val();selected=_this.target.hasClass("selected");_this.target.removeClass().removeAttr("data-lang");-1!==_this.lang&&_this.target.attr("data-lang",_this.lang);selected&&_this.target.addClass("selected");return _this.editor.trigger("valuechanged")}));return this.editor.on("valuechanged",function(_this){return function(e){if(_this.active)return _this.refresh()}}(this))};CodePopover.prototype.show=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];CodePopover.__super__.show.apply(this,args);this.lang=this.target.attr("data-lang");return null!=this.lang?this.selectEl.val(this.lang):this.selectEl.val(-1)};return CodePopover}();Simditor.Toolbar.addButton(CodeButton);LinkButton=function(superClass){extend(LinkButton,Button);function LinkButton(){return LinkButton.__super__.constructor.apply(this,arguments)}LinkButton.prototype.name="link";LinkButton.prototype.icon="link";LinkButton.prototype.htmlTag="a";LinkButton.prototype.disableTag="pre";LinkButton.prototype.render=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];LinkButton.__super__.render.apply(this,args);return this.popover=new LinkPopover({button:this})};LinkButton.prototype._status=function(){LinkButton.__super__._status.call(this);return this.active&&!this.editor.selection.rangeAtEndOf(this.node)?this.popover.show(this.node):this.popover.hide()};LinkButton.prototype.command=function(){var $contents,$link,$newBlock,linkText,range,txtNode,_this;range=this.editor.selection.range();if(this.active){txtNode=document.createTextNode(this.node.text());this.node.replaceWith(txtNode);range.selectNode(txtNode)}else{$contents=$(range.extractContents());linkText=this.editor.formatter.clearHtml($contents.contents(),!1);$link=$("<a/>",{href:"",target:"_blank",text:linkText||this._t("linkText")});if(0<this.editor.selection.blockNodes().length)range.insertNode($link[0]);else{$newBlock=$("<p/>").append($link);range.insertNode($newBlock[0])}range.selectNodeContents($link[0]);this.popover.one("popovershow",(_this=this,function(){if(linkText){_this.popover.urlEl.focus();return _this.popover.urlEl[0].select()}_this.popover.textEl.focus();return _this.popover.textEl[0].select()}))}this.editor.selection.range(range);return this.editor.trigger("valuechanged")};return LinkButton}();LinkPopover=function(superClass){extend(LinkPopover,Popover);function LinkPopover(){return LinkPopover.__super__.constructor.apply(this,arguments)}LinkPopover.prototype.render=function(){var tpl,_this;tpl='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("linkText")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+this._t("removeLink")+'"\n      tabindex="-1">\n      <span class="simditor-icon simditor-icon-unlink"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkTarget")+'</label>\n    <select class="link-target">\n      <option value="_blank">'+this._t("openLinkInNewWindow")+' (_blank)</option>\n      <option value="_self">'+this._t("openLinkInCurrentWindow")+" (_self)</option>\n    </select>\n  </div>\n</div>";this.el.addClass("link-popover").append(tpl);this.textEl=this.el.find(".link-text");this.urlEl=this.el.find(".link-url");this.unlinkEl=this.el.find(".btn-unlink");this.selectTarget=this.el.find(".link-target");this.textEl.on("keyup",(_this=this,function(e){if(13!==e.which){_this.target.text(_this.textEl.val());return _this.editor.inputManager.throttledValueChanged()}}));this.urlEl.on("keyup",function(_this){return function(e){var val;if(13!==e.which){val=_this.urlEl.val();!/^(http|https|ftp|ftps|file)?:\/\/|^(mailto|tel)?:|^\//gi.test(val)&&val&&(val="http://"+val);_this.target.attr("href",val);return _this.editor.inputManager.throttledValueChanged()}}}(this));$([this.urlEl[0],this.textEl[0]]).on("keydown",function(_this){return function(e){var range;if(13===e.which||27===e.which||!e.shiftKey&&9===e.which&&$(e.target).hasClass("link-url")){e.preventDefault();range=document.createRange();_this.editor.selection.setRangeAfter(_this.target,range);_this.hide();return _this.editor.inputManager.throttledValueChanged()}}}(this));this.unlinkEl.on("click",function(_this){return function(e){var range,txtNode;txtNode=document.createTextNode(_this.target.text());_this.target.replaceWith(txtNode);_this.hide();range=document.createRange();_this.editor.selection.setRangeAfter(txtNode,range);return _this.editor.inputManager.throttledValueChanged()}}(this));return this.selectTarget.on("change",function(_this){return function(e){_this.target.attr("target",_this.selectTarget.val());return _this.editor.inputManager.throttledValueChanged()}}(this))};LinkPopover.prototype.show=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];LinkPopover.__super__.show.apply(this,args);this.textEl.val(this.target.text());return this.urlEl.val(this.target.attr("href"))};return LinkPopover}();Simditor.Toolbar.addButton(LinkButton);ImageButton=function(superClass){extend(ImageButton,Button);function ImageButton(){return ImageButton.__super__.constructor.apply(this,arguments)}ImageButton.prototype.name="image";ImageButton.prototype.icon="picture-o";ImageButton.prototype.htmlTag="img";ImageButton.prototype.disableTag="pre, table";ImageButton.prototype.defaultImage="";ImageButton.prototype.needFocus=!1;ImageButton.prototype._init=function(){var item,k,len,ref,_this;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton)){this.menu=[];for(k=0,len=(ref=this.editor.opts.imageButton).length;k<len;k++){item=ref[k];this.menu.push({name:item+"-image",text:this._t(item+"Image")})}}else this.menu=!1;else null!=this.editor.uploader?this.menu=[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]:this.menu=!1;this.defaultImage=this.editor.opts.defaultImage;this.editor.body.on("click","img:not([data-non-image])",(_this=this,function(e){var $img,range;$img=$(e.currentTarget);(range=document.createRange()).selectNode($img[0]);_this.editor.selection.range(range);_this.editor.util.support.onselectionchange||_this.editor.trigger("selectionchanged");return!1}));this.editor.body.on("mouseup","img:not([data-non-image])",function(e){return!1});this.editor.on("selectionchanged.image",function(_this){return function(){var $contents,$img,range;if(null!=(range=_this.editor.selection.range())){if(1===($contents=$(range.cloneContents()).contents()).length&&$contents.is("img:not([data-non-image])")){$img=$(range.startContainer).contents().eq(range.startOffset);return _this.popover.show($img)}return _this.popover.hide()}}}(this));this.editor.on("valuechanged.image",function(_this){return function(){var $masks;if(0<($masks=_this.editor.wrapper.find(".simditor-image-loading")).length)return $masks.each(function(i,mask){var $img,$mask,file;if(!(($img=($mask=$(mask)).data("img"))&&0<$img.parent().length)){$mask.remove();if($img&&(file=$img.data("file"))){_this.editor.uploader.cancel(file);if(_this.editor.body.find("img.uploading").length<1)return _this.editor.uploader.trigger("uploadready",[file])}}})}}(this));return ImageButton.__super__._init.call(this)};ImageButton.prototype.render=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];ImageButton.__super__.render.apply(this,args);this.popover=new ImagePopover({button:this});if("upload"===this.editor.opts.imageButton)return this._initUploader(this.el)};ImageButton.prototype.renderMenu=function(){ImageButton.__super__.renderMenu.call(this);return this._initUploader()};ImageButton.prototype._initUploader=function($uploadItem){var $input,createInput,uploadProgress;null==$uploadItem&&($uploadItem=this.menuEl.find(".menu-item-upload-image"));if(null!=this.editor.uploader){$input=null;var _this;(createInput=(_this=this,function(){$input&&$input.remove();return $input=$("<input/>",{type:"file",title:_this._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo($uploadItem)}))();$uploadItem.on("click mousedown","input[type=file]",function(e){return e.stopPropagation()});$uploadItem.on("change","input[type=file]",function(_this){return function(e){if(_this.editor.inputManager.focused){_this.editor.uploader.upload($input,{inline:!0});createInput()}else{_this.editor.one("focus",function(e){_this.editor.uploader.upload($input,{inline:!0});return createInput()});_this.editor.focus()}return _this.wrapper.removeClass("menu-on")}}(this));this.editor.uploader.on("beforeupload",function(_this){return function(e,file){var $img;if(file.inline){if(file.img)$img=$(file.img);else{$img=_this.createImage(file.name);file.img=$img}$img.addClass("uploading");$img.data("file",file);return _this.editor.uploader.readImageFile(file.obj,function(img){var src;if($img.hasClass("uploading")){src=img?img.src:_this.defaultImage;return _this.loadImage($img,src,function(){if(_this.popover.active){_this.popover.refresh();return _this.popover.srcEl.val(_this._t("uploading")).prop("disabled",!0)}})}})}}}(this));uploadProgress=$.proxy(this.editor.util.throttle(function(e,file,loaded,total){var $img,$mask,percent;if(file.inline&&($mask=file.img.data("mask"))){if(($img=$mask.data("img"))&&$img.hasClass("uploading")&&0<$img.parent().length){99<(percent=(100*(percent=loaded/total)).toFixed(0))&&(percent=99);return $mask.find(".progress").height(100-percent+"%")}$mask.remove()}},500),this);this.editor.uploader.on("uploadprogress",uploadProgress);this.editor.uploader.on("uploadsuccess",function(_this){return function(e,file,result){var $img,img_path,msg;if(file.inline&&($img=file.img).hasClass("uploading")&&0<$img.parent().length){if("object"!=typeof result)try{result=$.parseJSON(result)}catch(_error){_error;result={success:!1}}if(!1===result.success){msg=result.msg||_this._t("uploadFailed");alert(msg);img_path=_this.defaultImage}else img_path=result.file_path;_this.loadImage($img,img_path,function(){var $mask;$img.removeData("file");$img.removeClass("uploading").removeClass("loading");($mask=$img.data("mask"))&&$mask.remove();$img.removeData("mask");_this.editor.trigger("valuechanged");if(_this.editor.body.find("img.uploading").length<1)return _this.editor.uploader.trigger("uploadready",[file,result])});if(_this.popover.active){_this.popover.srcEl.prop("disabled",!1);return _this.popover.srcEl.val(result.file_path)}}}}(this));return this.editor.uploader.on("uploaderror",function(_this){return function(e,file,xhr){var $img,result;if(file.inline&&"abort"!==xhr.statusText){if(xhr.responseText)try{(result=$.parseJSON(xhr.responseText)).msg}catch(_error){_error;_this._t("uploadError")}if(($img=file.img).hasClass("uploading")&&0<$img.parent().length){_this.loadImage($img,_this.defaultImage,function(){var $mask;$img.removeData("file");$img.removeClass("uploading").removeClass("loading");($mask=$img.data("mask"))&&$mask.remove();return $img.removeData("mask")});if(_this.popover.active){_this.popover.srcEl.prop("disabled",!1);_this.popover.srcEl.val(_this.defaultImage)}_this.editor.trigger("valuechanged");return _this.editor.body.find("img.uploading").length<1?_this.editor.uploader.trigger("uploadready",[file,result]):void 0}}}}(this))}this.el.find(".btn-upload").remove()};ImageButton.prototype._status=function(){return this._disableStatus()};ImageButton.prototype.loadImage=function($img,src,callback){var $mask,img,positionMask,_this;positionMask=(_this=this,function(){var imgOffset,wrapperOffset;imgOffset=$img.offset();wrapperOffset=_this.editor.wrapper.offset();return $mask.css({top:imgOffset.top-wrapperOffset.top,left:imgOffset.left-wrapperOffset.left,width:$img.width(),height:$img.height()}).show()});$img.addClass("loading");if(!($mask=$img.data("mask"))){$mask=$('<div class="simditor-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper);positionMask();$img.data("mask",$mask);$mask.data("img",$img)}(img=new Image).onload=function(_this){return function(){var height,width;if($img.hasClass("loading")||$img.hasClass("uploading")){width=img.width;height=img.height;$img.attr({src:src,width:width,height:height,"data-image-size":width+","+height}).removeClass("loading");if($img.hasClass("uploading")){_this.editor.util.reflow(_this.editor.body);positionMask()}else{$mask.remove();$img.removeData("mask")}return $.isFunction(callback)?callback(img):void 0}}}(this);img.onerror=function(){$.isFunction(callback)&&callback(!1);$mask.remove();return $img.removeData("mask").removeClass("loading")};return img.src=src};ImageButton.prototype.createImage=function(name){var $img,range;null==name&&(name="Image");this.editor.inputManager.focused||this.editor.focus();(range=this.editor.selection.range()).deleteContents();this.editor.selection.range(range);$img=$("<img/>").attr("alt",name);range.insertNode($img[0]);this.editor.selection.setRangeAfter($img,range);this.editor.trigger("valuechanged");return $img};ImageButton.prototype.command=function(src){var $img,_this;$img=this.createImage();return this.loadImage($img,src||this.defaultImage,(_this=this,function(){_this.editor.trigger("valuechanged");_this.editor.util.reflow($img);$img.click();return _this.popover.one("popovershow",function(){_this.popover.srcEl.focus();return _this.popover.srcEl[0].select()})}))};return ImageButton}();ImagePopover=function(superClass){extend(ImagePopover,Popover);function ImagePopover(){return ImagePopover.__super__.constructor.apply(this,arguments)}ImagePopover.prototype.offset={top:6,left:-4};ImagePopover.prototype.render=function(){var tpl,_this;tpl='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;"\n      title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+this._t("imageAlt")+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;"\n      title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>';this.el.addClass("image-popover").append(tpl);this.srcEl=this.el.find(".image-src");this.widthEl=this.el.find("#image-width");this.heightEl=this.el.find("#image-height");this.altEl=this.el.find("#image-alt");this.srcEl.on("keydown",(_this=this,function(e){var range;if(13===e.which&&!_this.target.hasClass("uploading")){e.preventDefault();range=document.createRange();_this.button.editor.selection.setRangeAfter(_this.target,range);return _this.hide()}}));this.srcEl.on("blur",function(_this){return function(e){return _this._loadImage(_this.srcEl.val())}}(this));this.el.find(".image-size").on("blur",function(_this){return function(e){_this._resizeImg($(e.currentTarget));return _this.el.data("popover").refresh()}}(this));this.el.find(".image-size").on("keyup",function(_this){return function(e){var inputEl;inputEl=$(e.currentTarget);if(13!==e.which&&27!==e.which&&9!==e.which)return _this._resizeImg(inputEl,!0)}}(this));this.el.find(".image-size").on("keydown",function(_this){return function(e){var $img,inputEl,range;inputEl=$(e.currentTarget);if(13===e.which||27===e.which){e.preventDefault();13===e.which?_this._resizeImg(inputEl):_this._restoreImg();$img=_this.target;_this.hide();range=document.createRange();return _this.button.editor.selection.setRangeAfter($img,range)}if(9===e.which)return _this.el.data("popover").refresh()}}(this));this.altEl.on("keydown",function(_this){return function(e){var range;if(13===e.which){e.preventDefault();range=document.createRange();_this.button.editor.selection.setRangeAfter(_this.target,range);return _this.hide()}}}(this));this.altEl.on("keyup",function(_this){return function(e){if(13!==e.which&&27!==e.which&&9!==e.which){_this.alt=_this.altEl.val();return _this.target.attr("alt",_this.alt)}}}(this));this.el.find(".btn-restore").on("click",function(_this){return function(e){_this._restoreImg();return _this.el.data("popover").refresh()}}(this));this.editor.on("valuechanged",function(_this){return function(e){if(_this.active)return _this.refresh()}}(this));return this._initUploader()};ImagePopover.prototype._initUploader=function(){var $uploadBtn,createInput;$uploadBtn=this.el.find(".btn-upload");if(null!=this.editor.uploader){var _this;(createInput=(_this=this,function(){_this.input&&_this.input.remove();return _this.input=$("<input/>",{type:"file",title:_this._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo($uploadBtn)}))();this.el.on("click mousedown","input[type=file]",function(e){return e.stopPropagation()});return this.el.on("change","input[type=file]",function(_this){return function(e){_this.editor.uploader.upload(_this.input,{inline:!0,img:_this.target});return createInput()}}(this))}$uploadBtn.remove()};ImagePopover.prototype._resizeImg=function(inputEl,onlySetVal){var height,value,width;null==onlySetVal&&(onlySetVal=!1);value=1*inputEl.val();if(this.target&&($.isNumeric(value)||value<0)){if(inputEl.is(this.widthEl)){width=value;height=this.height*value/this.width;this.heightEl.val(height)}else{height=value;width=this.width*value/this.height;this.widthEl.val(width)}if(!onlySetVal){this.target.attr({width:width,height:height});return this.editor.trigger("valuechanged")}}};ImagePopover.prototype._restoreImg=function(){var ref,size;size=(null!=(ref=this.target.data("image-size"))?ref.split(","):void 0)||[this.width,this.height];this.target.attr({width:1*size[0],height:1*size[1]});this.widthEl.val(size[0]);this.heightEl.val(size[1]);return this.editor.trigger("valuechanged")};ImagePopover.prototype._loadImage=function(src,callback){if(!/^data:image/.test(src)||this.editor.uploader){if(this.target.attr("src")!==src){return this.button.loadImage(this.target,src,(_this=this,function(img){var blob;if(img){if(_this.active){_this.width=img.width;_this.height=img.height;_this.widthEl.val(_this.width);_this.heightEl.val(_this.height)}if(/^data:image/.test(src)){(blob=_this.editor.util.dataURLtoBlob(src)).name="Base64 Image.png";_this.editor.uploader.upload(blob,{inline:!0,img:_this.target})}else _this.editor.trigger("valuechanged");return callback?callback(img):void 0}}));var _this}}else callback&&callback(!1)};ImagePopover.prototype.show=function(){var $img,args;args=1<=arguments.length?slice.call(arguments,0):[];ImagePopover.__super__.show.apply(this,args);$img=this.target;this.width=$img.width();this.height=$img.height();this.alt=$img.attr("alt");if($img.hasClass("uploading"))return this.srcEl.val(this._t("uploading")).prop("disabled",!0);this.srcEl.val($img.attr("src")).prop("disabled",!1);this.widthEl.val(this.width);this.heightEl.val(this.height);return this.altEl.val(this.alt)};return ImagePopover}();Simditor.Toolbar.addButton(ImageButton);IndentButton=function(superClass){extend(IndentButton,Button);function IndentButton(){return IndentButton.__super__.constructor.apply(this,arguments)}IndentButton.prototype.name="indent";IndentButton.prototype.icon="indent";IndentButton.prototype._init=function(){var hotkey;hotkey=!1===this.editor.opts.tabIndent?"":" (Tab)";this.title=this._t(this.name)+hotkey;return IndentButton.__super__._init.call(this)};IndentButton.prototype._status=function(){};IndentButton.prototype.command=function(){return this.editor.indentation.indent()};return IndentButton}();Simditor.Toolbar.addButton(IndentButton);OutdentButton=function(superClass){extend(OutdentButton,Button);function OutdentButton(){return OutdentButton.__super__.constructor.apply(this,arguments)}OutdentButton.prototype.name="outdent";OutdentButton.prototype.icon="outdent";OutdentButton.prototype._init=function(){var hotkey;hotkey=!1===this.editor.opts.tabIndent?"":" (Shift + Tab)";this.title=this._t(this.name)+hotkey;return OutdentButton.__super__._init.call(this)};OutdentButton.prototype._status=function(){};OutdentButton.prototype.command=function(){return this.editor.indentation.indent(!0)};return OutdentButton}();Simditor.Toolbar.addButton(OutdentButton);HrButton=function(superClass){extend(HrButton,Button);function HrButton(){return HrButton.__super__.constructor.apply(this,arguments)}HrButton.prototype.name="hr";HrButton.prototype.icon="minus";HrButton.prototype.htmlTag="hr";HrButton.prototype._status=function(){};HrButton.prototype.command=function(){var $hr,$newBlock,$rootBlock;0<($rootBlock=this.editor.selection.rootNodes().first()).next().length?this.editor.selection.save():$newBlock=$("<p/>").append(this.editor.util.phBr);$hr=$("<hr/>").insertAfter($rootBlock);if($newBlock){$newBlock.insertAfter($hr);this.editor.selection.setRangeAtStartOf($newBlock)}else this.editor.selection.restore();return this.editor.trigger("valuechanged")};return HrButton}();Simditor.Toolbar.addButton(HrButton);TableButton=function(superClass){extend(TableButton,Button);function TableButton(){return TableButton.__super__.constructor.apply(this,arguments)}TableButton.prototype.name="table";TableButton.prototype.icon="table";TableButton.prototype.htmlTag="table";TableButton.prototype.disableTag="pre, li, blockquote";TableButton.prototype.menu=!0;TableButton.prototype._init=function(){TableButton.__super__._init.call(this);$.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]);$.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]});$.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]});this._initShortcuts();this._initResize();this.editor.on("decorate",(_this=this,function(e,$el){return $el.find("table").each(function(i,table){return _this.decorate($(table))})}));var _this;this.editor.on("undecorate",function(_this){return function(e,$el){return $el.find("table").each(function(i,table){return _this.undecorate($(table))})}}(this));this.editor.on("selectionchanged.table",function(_this){return function(e){var $container,range;_this.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active");if(range=_this.editor.selection.range()){$container=_this.editor.selection.containerNode();range.collapsed&&$container.is(".simditor-table")&&_this.editor.selection.setRangeAtEndOf($container);return $container.closest("td, th",_this.editor.body).addClass("active")}}}(this));this.editor.on("blur.table",function(_this){return function(e){return _this.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")}}(this));this.editor.keystroke.add("up","td",function(_this){return function(e,$node){_this._tdNav($node,"up");return!0}}(this));this.editor.keystroke.add("up","th",function(_this){return function(e,$node){_this._tdNav($node,"up");return!0}}(this));this.editor.keystroke.add("down","td",function(_this){return function(e,$node){_this._tdNav($node,"down");return!0}}(this));return this.editor.keystroke.add("down","th",function(_this){return function(e,$node){_this._tdNav($node,"down");return!0}}(this))};TableButton.prototype._tdNav=function($td,direction){var $anotherTr,$tr,action,index,ref;null==direction&&(direction="up");action="up"===direction?"prev":"next";(ref="up"===direction?["tbody","thead"]:["thead","tbody"])[0],ref[1];$tr=$td.parent("tr");if(!(0<($anotherTr=this["_"+action+"Row"]($tr)).length))return!0;index=$tr.find("td, th").index($td);return this.editor.selection.setRangeAtEndOf($anotherTr.find("td, th").eq(index))};TableButton.prototype._nextRow=function($tr){var $nextTr;($nextTr=$tr.next("tr")).length<1&&0<$tr.parent("thead").length&&($nextTr=$tr.parent("thead").next("tbody").find("tr:first"));return $nextTr};TableButton.prototype._prevRow=function($tr){var $prevTr;($prevTr=$tr.prev("tr")).length<1&&0<$tr.parent("tbody").length&&($prevTr=$tr.parent("tbody").prev("thead").find("tr"));return $prevTr};TableButton.prototype._initResize=function(){var $editor;$editor=this.editor;$(document).on("mousemove.simditor-table",".simditor-table td, .simditor-table th",function(e){var $col,$colgroup,$resizeHandle,$td,$wrapper,index,ref,ref1;$resizeHandle=($wrapper=$(this).parents(".simditor-table")).find(".simditor-resize-handle");$colgroup=$wrapper.find("colgroup");if(!$wrapper.hasClass("resizing")){$td=$(e.currentTarget);e.pageX-$(e.currentTarget).offset().left<5&&0<$td.prev().length&&($td=$td.prev());if($td.next("td, th").length<1)$resizeHandle.hide();else if(null!=(ref=$resizeHandle.data("td"))&&ref.is($td))$resizeHandle.show();else{index=$td.parent().find("td, th").index($td);$col=$colgroup.find("col").eq(index);if(null==(ref1=$resizeHandle.data("col"))||!ref1.is($col))return $resizeHandle.css("left",$td.position().left+$td.outerWidth()-5).data("td",$td).data("col",$col).show();$resizeHandle.show()}}});$(document).on("mouseleave.simditor-table",".simditor-table",function(e){return $(this).find(".simditor-resize-handle").hide()});return $(document).on("mousedown.simditor-resize-handle",".simditor-resize-handle",function(e){var $handle,$leftCol,$leftTd,$rightCol,$rightTd,$wrapper,startHandleLeft,startLeftWidth,startRightWidth,startX,tableWidth;$wrapper=$(this).parent(".simditor-table");$leftTd=($handle=$(e.currentTarget)).data("td");$leftCol=$handle.data("col");$rightTd=$leftTd.next("td, th");$rightCol=$leftCol.next("col");startX=e.pageX;startLeftWidth=1*$leftTd.outerWidth();startRightWidth=1*$rightTd.outerWidth();startHandleLeft=parseFloat($handle.css("left"));tableWidth=$leftTd.closest("table").width();50;$(document).on("mousemove.simditor-resize-table",function(e){var deltaX,leftWidth,rightWidth;deltaX=e.pageX-startX;rightWidth=startRightWidth-deltaX;(leftWidth=startLeftWidth+deltaX)<50?rightWidth=startRightWidth-(deltaX=(leftWidth=50)-startLeftWidth):rightWidth<50&&(leftWidth=startLeftWidth+(deltaX=startRightWidth-(rightWidth=50)));$leftCol.attr("width",leftWidth/tableWidth*100+"%");$rightCol.attr("width",rightWidth/tableWidth*100+"%");return $handle.css("left",startHandleLeft+deltaX)});$(document).one("mouseup.simditor-resize-table",function(e){$editor.sync();$(document).off(".simditor-resize-table");return $wrapper.removeClass("resizing")});$wrapper.addClass("resizing");return!1})};TableButton.prototype._initShortcuts=function(){this.editor.hotkeys.add("ctrl+alt+up",(_this=this,function(e){_this.editMenu.find(".menu-item[data-param=insertRowAbove]").click();return!1}));var _this;this.editor.hotkeys.add("ctrl+alt+down",function(_this){return function(e){_this.editMenu.find(".menu-item[data-param=insertRowBelow]").click();return!1}}(this));this.editor.hotkeys.add("ctrl+alt+left",function(_this){return function(e){_this.editMenu.find(".menu-item[data-param=insertColLeft]").click();return!1}}(this));return this.editor.hotkeys.add("ctrl+alt+right",function(_this){return function(e){_this.editMenu.find(".menu-item[data-param=insertColRight]").click();return!1}}(this))};TableButton.prototype.decorate=function($table){var $colgroup,$headRow,$tbody,$thead,$wrapper;0<$table.parent(".simditor-table").length&&this.undecorate($table);$table.wrap('<div class="simditor-table"></div>');$wrapper=$table.parent(".simditor-table");$colgroup=$table.find("colgroup");if($table.find("thead").length<1){$thead=$("<thead />");$headRow=$table.find("tr").first();$thead.append($headRow);this._changeCellTag($headRow,"th");0<($tbody=$table.find("tbody")).length?$tbody.before($thead):$table.prepend($thead)}if($colgroup.length<1){$colgroup=$("<colgroup/>").prependTo($table);$table.find("thead tr th").each(function(i,td){return $("<col/>").appendTo($colgroup)});this.refreshTableWidth($table)}$("<div />",{class:"simditor-resize-handle",contenteditable:"false"}).appendTo($wrapper);return $table.parent()};TableButton.prototype.undecorate=function($table){if(0<$table.parent(".simditor-table").length)return $table.parent().replaceWith($table)};TableButton.prototype.renderMenu=function(){var $table,_this;$('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+this._t("deleteRow")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+this._t("deleteColumn")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+this._t("deleteTable")+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper);this.createMenu=this.menuWrapper.find(".menu-create-table");this.editMenu=this.menuWrapper.find(".menu-edit-table");$table=this.createTable(6,6).appendTo(this.createMenu);this.createMenu.on("mouseenter","td, th",(_this=this,function(e){var $td,$tr,$trs,num;_this.createMenu.find("td, th").removeClass("selected");num=($tr=($td=$(e.currentTarget)).parent()).find("td, th").index($td)+1;$trs=$tr.prevAll("tr").addBack();$tr.parent().is("tbody")&&($trs=$trs.add($table.find("thead tr")));return $trs.find("td:lt("+num+"), th:lt("+num+")").addClass("selected")}));this.createMenu.on("mouseleave",function(e){return $(e.currentTarget).find("td, th").removeClass("selected")});return this.createMenu.on("mousedown","td, th",function(_this){return function(e){var $closestBlock,$td,$tr,colNum,rowNum;_this.wrapper.removeClass("menu-on");if(_this.editor.inputManager.focused){colNum=($tr=($td=$(e.currentTarget)).parent()).find("td").index($td)+1;rowNum=$tr.prevAll("tr").length+1;$tr.parent().is("tbody")&&(rowNum+=1);$table=_this.createTable(rowNum,colNum,!0);$closestBlock=_this.editor.selection.blockNodes().last();_this.editor.util.isEmptyNode($closestBlock)?$closestBlock.replaceWith($table):$closestBlock.after($table);_this.decorate($table);_this.editor.selection.setRangeAtStartOf($table.find("th:first"));_this.editor.trigger("valuechanged");return!1}}}(this))};TableButton.prototype.createTable=function(row,col,phBr){var $table,$tbody,$td,$thead,$tr,k,l,r,ref,ref1;$table=$("<table/>");$thead=$("<thead/>").appendTo($table);$tbody=$("<tbody/>").appendTo($table);for(r=k=0,ref=row;0<=ref?k<ref:ref<k;r=0<=ref?++k:--k){($tr=$("<tr/>")).appendTo(0===r?$thead:$tbody);for(l=0,ref1=col;0<=ref1?l<ref1:ref1<l;0<=ref1?++l:--l){$td=$(0===r?"<th/>":"<td/>").appendTo($tr);phBr&&$td.append(this.editor.util.phBr)}}return $table};TableButton.prototype.refreshTableWidth=function($table){return setTimeout(function(){var cols,tableWidth;tableWidth=$table.width();cols=$table.find("col");return $table.find("thead tr th").each(function(i,td){return cols.eq(i).attr("width",$(td).outerWidth()/tableWidth*100+"%")})},0)};TableButton.prototype.setActive=function(active){TableButton.__super__.setActive.call(this,active);if(active){this.createMenu.hide();return this.editMenu.show()}this.createMenu.show();return this.editMenu.hide()};TableButton.prototype._changeCellTag=function($tr,tagName){return $tr.find("td, th").each(function(i,cell){var $cell;return($cell=$(cell)).replaceWith("<"+tagName+">"+$cell.html()+"</"+tagName+">")})};TableButton.prototype.deleteRow=function($td){var $newTr,$tr,index;if(($tr=$td.parent("tr")).closest("table").find("tr").length<1)return this.deleteTable($td);0<($newTr=this._nextRow($tr)).length||($newTr=this._prevRow($tr));index=$tr.find("td, th").index($td);if($tr.parent().is("thead")){$newTr.appendTo($tr.parent());this._changeCellTag($newTr,"th")}$tr.remove();return this.editor.selection.setRangeAtEndOf($newTr.find("td, th").eq(index))};TableButton.prototype.insertRow=function($td,direction){var $newTr,$table,$tr,cellTag,colNum,index,k,ref;null==direction&&(direction="after");$table=($tr=$td.parent("tr")).closest("table");colNum=0;$table.find("tr").each(function(i,tr){return colNum=Math.max(colNum,$(tr).find("td").length)});index=$tr.find("td, th").index($td);$newTr=$("<tr/>");cellTag="td";if("after"===direction&&$tr.parent().is("thead"))$tr.parent().next("tbody").prepend($newTr);else if("before"===direction&&$tr.parent().is("thead")){$tr.before($newTr);$tr.parent().next("tbody").prepend($tr);this._changeCellTag($tr,"td");cellTag="th"}else $tr[direction]($newTr);for(k=1,ref=colNum;1<=ref?k<=ref:ref<=k;1<=ref?++k:--k)$("<"+cellTag+"/>").append(this.editor.util.phBr).appendTo($newTr);return this.editor.selection.setRangeAtStartOf($newTr.find("td, th").eq(index))};TableButton.prototype.deleteCol=function($td){var $newTd,$table,$tr,index,noOtherCol,noOtherRow;noOtherRow=($tr=$td.parent("tr")).closest("table").find("tr").length<2;noOtherCol=$td.siblings("td, th").length<1;if(noOtherRow&&noOtherCol)return this.deleteTable($td);index=$tr.find("td, th").index($td);0<($newTd=$td.next("td, th")).length||($newTd=$tr.prev("td, th"));($table=$tr.closest("table")).find("col").eq(index).remove();$table.find("tr").each(function(i,tr){return $(tr).find("td, th").eq(index).remove()});this.refreshTableWidth($table);return this.editor.selection.setRangeAtEndOf($newTd)};TableButton.prototype.insertCol=function($td,direction){var $col,$newCol,$newTd,$table,$tr,index,tableWidth,width,_this;null==direction&&(direction="after");$tr=$td.parent("tr");index=$tr.find("td, th").index($td);$col=($table=$td.closest("table")).find("col").eq(index);$table.find("tr").each((_this=this,function(i,tr){var $newTd,cellTag;cellTag=$(tr).parent().is("thead")?"th":"td";$newTd=$("<"+cellTag+"/>").append(_this.editor.util.phBr);return $(tr).find("td, th").eq(index)[direction]($newTd)}));$newCol=$("<col/>");$col[direction]($newCol);tableWidth=$table.width();width=Math.max(parseFloat($col.attr("width"))/2,50/tableWidth*100);$col.attr("width",width+"%");$newCol.attr("width",width+"%");this.refreshTableWidth($table);$newTd="after"===direction?$td.next("td, th"):$td.prev("td, th");return this.editor.selection.setRangeAtStartOf($newTd)};TableButton.prototype.deleteTable=function($td){var $block,$table;$block=($table=$td.closest(".simditor-table")).next("p");$table.remove();if(0<$block.length)return this.editor.selection.setRangeAtStartOf($block)};TableButton.prototype.command=function(param){var $td;if(0<($td=this.editor.selection.containerNode().closest("td, th")).length){if("deleteRow"===param)this.deleteRow($td);else if("insertRowAbove"===param)this.insertRow($td,"before");else if("insertRowBelow"===param)this.insertRow($td);else if("deleteCol"===param)this.deleteCol($td);else if("insertColLeft"===param)this.insertCol($td,"before");else if("insertColRight"===param)this.insertCol($td);else{if("deleteTable"!==param)return;this.deleteTable($td)}return this.editor.trigger("valuechanged")}};return TableButton}();Simditor.Toolbar.addButton(TableButton);StrikethroughButton=function(superClass){extend(StrikethroughButton,Button);function StrikethroughButton(){return StrikethroughButton.__super__.constructor.apply(this,arguments)}StrikethroughButton.prototype.name="strikethrough";StrikethroughButton.prototype.icon="strikethrough";StrikethroughButton.prototype.htmlTag="strike";StrikethroughButton.prototype.disableTag="pre";StrikethroughButton.prototype._activeStatus=function(){var active;active=!0===document.queryCommandState("strikethrough");this.setActive(active);return this.active};StrikethroughButton.prototype.command=function(){document.execCommand("strikethrough");this.editor.util.support.oninput||this.editor.trigger("valuechanged");return $(document).trigger("selectionchange")};return StrikethroughButton}();Simditor.Toolbar.addButton(StrikethroughButton);AlignmentButton=function(superClass){extend(AlignmentButton,Button);function AlignmentButton(){return AlignmentButton.__super__.constructor.apply(this,arguments)}AlignmentButton.prototype.name="alignment";AlignmentButton.prototype.icon="align-left";AlignmentButton.prototype.htmlTag="p, h1, h2, h3, h4, td, th";AlignmentButton.prototype._init=function(){this.menu=[{name:"left",text:this._t("alignLeft"),icon:"align-left",param:"left"},{name:"center",text:this._t("alignCenter"),icon:"align-center",param:"center"},{name:"right",text:this._t("alignRight"),icon:"align-right",param:"right"}];return AlignmentButton.__super__._init.call(this)};AlignmentButton.prototype.setActive=function(active,align){null==align&&(align="left");"left"!==align&&"center"!==align&&"right"!==align&&(align="left");"left"===align?AlignmentButton.__super__.setActive.call(this,!1):AlignmentButton.__super__.setActive.call(this,active);this.el.removeClass("align-left align-center align-right");active&&this.el.addClass("align-"+align);this.setIcon("align-"+align);return this.menuEl.find(".menu-item").show().end().find(".menu-item-"+align).hide()};AlignmentButton.prototype._status=function(){this.nodes=this.editor.selection.nodes().filter(this.htmlTag);if(this.nodes.length<1){this.setDisabled(!0);return this.setActive(!1)}this.setDisabled(!1);return this.setActive(!0,this.nodes.first().css("text-align"))};AlignmentButton.prototype.command=function(align){if("left"!==align&&"center"!==align&&"right"!==align)throw new Error("simditor alignment button: invalid align "+align);this.nodes.css({"text-align":"left"===align?"":align});this.editor.trigger("valuechanged");return this.editor.inputManager.throttledSelectionChanged()};return AlignmentButton}();Simditor.Toolbar.addButton(AlignmentButton);return Simditor});